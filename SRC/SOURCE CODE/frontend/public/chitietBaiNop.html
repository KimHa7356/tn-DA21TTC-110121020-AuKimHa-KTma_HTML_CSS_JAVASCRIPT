<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi tiết Bài Nộp</title>
    <link rel="icon" type="image/x-icon" href="/public/favicon.ico" />
    <link rel="stylesheet" href="/public/output.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f9fafb;
        color: #1e293b;
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        overflow-y: hidden;
      }

      ::-webkit-scrollbar {
        display: none;
      }

      * {
        scrollbar-width: none;
      }

      .opacity-50 {
        opacity: 0.5;
        pointer-events: none;
      }

      .sidebar {
        width: 280px;
        background: #ffffff;
        height: 100vh;
        position: fixed;
        top: 0px;
        left: 0px;
        padding: 2rem;
        border-right: 1px solid #e5e7eb;
        overflow-y: auto;
      }

      .sidebar .user-info {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
        position: relative;
      }

      .sidebar .user-info img {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        margin-right: 1rem;
        object-fit: cover;
        border: 2px solid #4b6cb7;
      }

      .sidebar .user-info .edit-icon {
        position: absolute;
        top: 48px;
        right: 5px;
        background: #4b6cb7;
        border-radius: 50%;
        padding: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .sidebar .user-info .edit-icon svg {
        width: 16px;
        height: 16px;
        stroke: #ffffff;
      }

      .sidebar .user-info .user-details h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #333333;
      }

      .sidebar .user-info .user-details p {
        font-size: 0.875rem;
        color: #666666;
        font-weight: 500;
      }

      .sidebar nav ul {
        list-style: none;
        padding: 0;
      }

      .sidebar nav ul li {
        margin-bottom: 0.5rem;
      }

      .sidebar nav ul li a {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        color: #333333;
        text-decoration: none;
        border-radius: 0.375rem;
        font-size: 0.95rem;
        background: #f0f2f5;
        transition: background-color 0.2s;
        position: relative;
      }

      .sidebar nav ul li a.active {
        background: #4b6cb7;
        color: #ffffff;
        font-weight: bold;
      }

      .sidebar nav ul li a svg {
        width: 1.125rem;
        height: 1.125rem;
        margin-right: 0.5rem;
        stroke: currentColor;
      }

      .hidden {
        display: none !important;
      }

      .info-sub-buttons,
      .class-sub-buttons,
      .exercise-sub-buttons,
      .account-sub-buttons {
        display: none;
        margin-left: 1.5rem;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .info-sub-buttons a,
      .class-sub-buttons a,
      .exercise-sub-buttons a,
      .account-sub-buttons a {
        display: flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        font-size: 0.85rem;
        color: #333333;
        text-decoration: none;
        background: #e0e7ff;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .info-sub-buttons a:hover,
      .class-sub-buttons a:hover,
      .exercise-sub-buttons a:hover,
      .account-sub-buttons a:hover {
        background-color: #c7d2fe;
        color: #1e40af;
      }

      .info-sub-buttons a svg,
      .class-sub-buttons a svg,
      .exercise-sub-buttons a svg,
      .account-sub-buttons a svg {
        width: 1rem;
        height: 1rem;
        margin-right: 0.5rem;
        stroke: currentColor;
      }

      .main-content {
        margin-left: 280px;
        min-height: 100vh;
        padding: 1.5rem;
        padding-top: 70px;
        overflow-y: hidden;
      }

      header {
        background: #4b6cb7;
        color: #ffffff;
        padding: 1rem 2rem;
        position: fixed;
        top: 0;
        left: 280px;
        right: 0;
        z-index: 40;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 60px;
      }

      header button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        cursor: pointer;
      }

      .back-btn {
        color: #ffffff;
      }

      .logout-btn {
        color: #ffffff;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
        background: #ffffff;
        padding: 2.5rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
      }

      h1 {
        font-size: 2.1rem;
        font-weight: 700;
        text-align: center;
        color: #1e293b;
        margin-bottom: 2.5rem;
      }

      .submission-content {
        padding: 2rem;
        background: #f9fafb;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
      }

      .submission-content pre {
        white-space: pre-wrap;
        word-break: break-word;
        font-family: "Courier New", Courier, monospace;
        background: #f1f5f9;
        padding: 1rem;
        border-radius: 0.375rem;
      }

      .success-message,
      .error-message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 1000;
        display: none;
      }

      .success-message {
        background-color: #d1fae5;
        color: #065f46;
      }

      .error-message {
        background-color: #fee2e2;
        color: #991b1b;
      }

      .success-message:not(.hidden),
      .error-message:not(.hidden) {
        display: block;
      }

      .submission-content p {
        margin-bottom: 1rem;
      }

      .submission-content .answer-item {
        margin-bottom: 1rem;
      }

      .submission-content .answer-item p {
        margin: 0.5rem 0;
      }

      .submission-content .answer-item p:first-child {
        font-weight: 600;
      }

      .content-container {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
      }

      .content-box {
        flex: 1;
        background: #ffffff;
        padding: 1.5rem;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .content-box h3 {
        margin-top: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #1e293b;
      }

      .content-box pre {
        background: #f1f5f9;
        padding: 1rem;
        border-radius: 0.375rem;
        font-size: 0.9rem;
      }

      .content-box pre code {
        font-family: "Courier New", Courier, monospace;
      }

      @media (max-width: 768px) {
        .sidebar {
          width: 100%;
          height: auto;
          position: relative;
        }
        .main-content {
          margin-left: 0;
        }
        header {
          left: 0;
        }
        .content-container {
          flex-direction: column;
          gap: 1rem;
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-100 font-['Inter',sans-serif] min-h-screen flex flex-col"
  >
    <div id="successMessage" class="success-message hidden"></div>
    <div id="errorMessage" class="error-message hidden"></div>

    <div class="flex mt-4">
      <aside id="sidebar" class="sidebar">
        <div class="user-info">
          <img
            id="userAvatar"
            src="/images/default-avatar.png"
            alt="Ảnh đại diện người dùng"
          />
          <a
            href="/chinhsuathongtin"
            class="edit-icon"
            title="Chỉnh sửa thông tin"
            aria-label="Chỉnh sửa thông tin cá nhân"
            rel="noopener noreferrer"
          >
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              ></path>
            </svg>
          </a>
          <div class="user-details">
            <h3 id="userName">Tên người dùng</h3>
            <p id="userEmail">email@example.com</p>
            <p id="userRole">Vai trò: Chưa xác định</p>
          </div>
        </div>
        <nav>
          <ul>
            <li>
              <a
                href="#"
                id="viewInfoSidebar"
                class="flex items-center px-4 py-2 rounded-lg font-medium"
                style="background-color: #f0f2f5; color: #333333"
                aria-label="Xem thông tin"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
                Xem thông tin
              </a>
              <div class="info-sub-buttons" id="infoSubButtons">
                <a
                  href="/thongtin/giangvien"
                  class="subitem"
                  id="teacherInfoButton"
                  aria-label="Thông tin giảng viên"
                >
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5zM12 15c-3.313 0-6 1.343-6 3v1h12v-1c0-1.657-2.687-3-6-3z"
                    ></path>
                  </svg>
                  Giảng viên
                </a>
                <a
                  href="/thongtin/sinhvien"
                  class="subitem"
                  aria-label="Thông tin sinh viên"
                >
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5zM12 15c-3.313 0-6 1.343-6 3v1h12v-1c0-1.657-2.687-3-6-3z"
                    ></path>
                  </svg>
                  Sinh viên
                </a>
              </div>
            </li>
            <li id="manageExerciseItem">
              <a
                href="#"
                id="manageExerciseSidebar"
                class="flex items-center px-4 py-2 rounded-lg font-medium"
                style="background-color: #f0f2f5; color: #333333"
                aria-label="Quản lý bài tập"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  ></path>
                </svg>
                Quản lý bài tập
              </a>
              <div class="exercise-sub-buttons" id="exerciseSubButtons">
                <a href="/taoBT" class="subitem" aria-label="Tạo bài tập">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    ></path>
                  </svg>
                  Tạo bài tập
                </a>
                <a
                  href="/danhsachbaitap"
                  class="subitem active"
                  aria-label="Danh sách bài tập"
                >
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                    ></path>
                  </svg>
                  Danh sách bài tập
                </a>
              </div>
            </li>
            <li id="manageClassItem">
              <a
                href="#"
                id="manageClassSidebar"
                class="flex items-center px-4 py-2 rounded-lg font-medium"
                style="background-color: #f0f2f5; color: #333333"
                aria-label="Quản lý lớp"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 18"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                  ></path>
                </svg>
                Quản lý lớp
              </a>
              <div class="class-sub-buttons" id="classSubButtons">
                <a href="/taolophoc" class="subitem" aria-label="Tạo lớp học">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    ></path>
                  </svg>
                  Tạo lớp học
                </a>
                <a
                  href="/danhsachlop"
                  class="subitem"
                  aria-label="Danh sách lớp"
                >
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                    ></path>
                  </svg>
                  Danh sách lớp
                </a>
              </div>
            </li>
            <li>
              <a
                href="/timkiemlophoc"
                id="searchClassSidebar"
                class="flex items-center px-4 py-2 rounded-lg font-medium"
                style="background-color: #f0f2f5; color: #333333"
                aria-label="Tìm kiếm lớp học"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  ></path>
                </svg>
                Tìm kiếm lớp học
              </a>
            </li>
            <li id="manageAccountItem">
              <a
                href="#"
                id="manageAccountSidebar"
                class="flex items-center px-4 py-2 rounded-lg font-medium"
                style="background-color: #f0f2f5; color: #333333"
                aria-label="Quản lý tài khoản"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  ></path>
                </svg>
                Quản lý tài khoản
              </a>
              <div class="account-sub-buttons" id="accountSubButtons">
                <a
                  href="/themgiangvien"
                  class="subitem"
                  id="addTeacherButton"
                  aria-label="Thêm giảng viên"
                >
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5zM12 15c-3.313 0-6 1.343-6 3v1h12v-1c0-1.657-2.687-3-6-3z"
                    ></path>
                  </svg>
                  Thêm giảng viên
                </a>
                <a
                  href="/themsinhvien"
                  class="subitem"
                  id="addStudentButton"
                  aria-label="Thêm sinh viên"
                >
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5zM12 15c-3.313 0-6 1.343-6 3v1h12v-1c0-1.657-2.687-3-6-3z"
                    ></path>
                  </svg>
                  Thêm sinh viên
                </a>
              </div>
            </li>
          </ul>
        </nav>
      </aside>

      <main id="mainContent" class="main-content flex-1">
        <header>
          <div class="flex items-center space-x-2">
            <button
              id="backButton"
              class="back-btn"
              onclick="const urlParams = new URLSearchParams(window.location.search); const exerciseId = urlParams.get('ma_bai_tap'); window.location.href = `/chitietBT.html?ma_bai_tap=${exerciseId}`;"
            >
              <svg
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                style="width: 1.25rem; height: 1.25rem"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 19l-7-7m0 0l7-7m-7 7h18"
                ></path>
              </svg>
              Quay lại trang chính
            </button>
          </div>
          <div class="flex items-center space-x-2">
            <span
              id="userRoleHeader"
              class="text-white font-medium hidden"
            ></span>
            <button
              id="logoutButton"
              class="logout-btn bg-red-600 hover:bg-red-700"
            >
              <svg
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                style="width: 1.25rem; height: 1.25rem"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 16l-4-4m0 0l-4-4m4 4H7m5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h3a3 3 0 013 3v1"
                ></path>
              </svg>
              Đăng xuất
            </button>
          </div>
        </header>

        <div class="container">
          <h1>Chi tiết Bài Nộp</h1>
          <div class="submission-content">
            <p>
              <strong>Tên người nộp:</strong>
              <span id="ten-hien-thi">Đang tải...</span>
            </p>
            <p>
              <strong>Thời gian nộp:</strong>
              <span id="thoi-gian-nop">Đang tải...</span>
            </p>
            <p>
              <strong>Trạng thái:</strong>
              <span id="trang-thai">Đang tải...</span>
            </p>
            <p>
              <strong>Lần nộp:</strong> <span id="lan-nop">Đang tải...</span>
            </p>
            <div class="content-container">
              <div class="content-box" id="newFormatContent">
                <h3>Mã nguồn bài nộp</h3>
                <div id="submissionContentNew">Đang tải nội dung...</div>
              </div>
              <div class="content-box" id="oldFormatContent">
                <h3>Kết quả hiển thị</h3>
                <div id="submissionContentOld">Đang tải nội dung...</div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Hàm hiển thị thông báo thành công
      function showSuccessMessage(message) {
        const successMessage = document.getElementById("successMessage");
        successMessage.textContent = message;
        successMessage.classList.remove("hidden");
        setTimeout(() => successMessage.classList.add("hidden"), 3000);
      }

      // Hàm hiển thị thông báo lỗi
      function showErrorMessage(message) {
        const errorMessage = document.getElementById("errorMessage");
        errorMessage.textContent = message;
        errorMessage.classList.remove("hidden");
        setTimeout(() => errorMessage.classList.add("hidden"), 3000);
      }

      // Hàm kiểm tra và làm mới token
      async function checkAndRefreshToken() {
        const token = localStorage.getItem("access_token");
        const refreshToken = localStorage.getItem("refresh_token");
        if (!token) {
          alert("Vui lòng đăng nhập để tiếp tục!");
          window.location.href = "/dangnhap";
          return null;
        }
        try {
          const response = await fetch(
            `http://127.0.0.1:8000/check_token/?_=${Date.now()}`,
            {
              headers: { Authorization: `Bearer ${token}` },
              cache: "no-store",
            }
          );
          if (!response.ok) {
            if (response.status === 401 && refreshToken) {
              const refreshResponse = await fetch(
                "http://127.0.0.1:8000/refresh_token/",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                  },
                  body: `refresh_token=${encodeURIComponent(refreshToken)}`,
                }
              );
              if (refreshResponse.ok) {
                const data = await refreshResponse.json();
                localStorage.setItem("access_token", data.access_token);
                localStorage.setItem("refresh_token", data.refresh_token);
                return data.access_token;
              } else {
                alert("Phiên làm việc đã hết hạn. Vui lòng đăng nhập lại!");
                window.location.href = "/dangnhap";
                return null;
              }
            } else {
              throw new Error("Lỗi xác thực token");
            }
          }
          return token;
        } catch (err) {
          console.error("Lỗi kiểm tra token:", err);
          alert("Đã xảy ra lỗi khi xác thực. Vui lòng đăng nhập lại!");
          return null;
        }
      }

      // Hàm lấy dữ liệu bài nộp từ API
      async function fetchSubmissionData(exerciseId, submissionId, token) {
        try {
          const response = await fetch(
            `http://127.0.0.1:8000/exercises/${exerciseId}/submissions/${submissionId}/`,
            {
              headers: { Authorization: `Bearer ${token}` },
              cache: "no-store",
            }
          );
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "Không thể tải nội dung bài nộp!");
          }
          return await response.json();
        } catch (err) {
          throw err;
        }
      }

      // Hàm parse nội dung bài nộp
      function parseSubmissionContent(noiDungNop) {
        if (!noiDungNop) {
          return { error: "Nội dung bài nộp trống" };
        }
        try {
          if (typeof noiDungNop === "object") {
            return { data: noiDungNop };
          }
          return { data: JSON.parse(noiDungNop) };
        } catch (e) {
          console.error("Lỗi khi phân tích noi_dung_nop:", e);
          return { error: "Nội dung bài nộp không hợp lệ" };
        }
      }

      // Hàm hiển thị dạng cũ (Kết quả hiển thị)
      function displayOldFormat(parsedContent, contentElement) {
        contentElement.innerHTML = ""; // Xóa nội dung cũ

        if (parsedContent.html) {
          contentElement.innerHTML = parsedContent.html;
        } else if (parsedContent.css || parsedContent.js) {
          const pre = document.createElement("pre");
          pre.textContent = JSON.stringify(parsedContent, null, 2);
          contentElement.appendChild(pre);
        } else if (Object.keys(parsedContent).length > 0) {
          for (const [key, value] of Object.entries(parsedContent)) {
            const answerDiv = document.createElement("div");
            answerDiv.className = "answer-item";

            const questionLabel = document.createElement("p");
            questionLabel.style.fontWeight = "bold";
            questionLabel.textContent = `Câu ${key}:`;
            answerDiv.appendChild(questionLabel);

            const answerContent = document.createElement("p");
            answerContent.textContent = value
              ? String(value)
              : "Không có câu trả lời";
            answerDiv.appendChild(answerContent);

            contentElement.appendChild(answerDiv);
          }
        } else {
          const noContent = document.createElement("p");
          noContent.textContent = "Không có nội dung chi tiết";
          contentElement.appendChild(noContent);
        }
      }

      // Hàm hiển thị dạng mới (Mã nguồn bài nộp)
      function displayNewFormat(parsedContent, contentElement) {
        contentElement.innerHTML = ""; // Xóa nội dung cũ

        if (!parsedContent.html && !parsedContent.css && !parsedContent.js) {
          const noContent = document.createElement("p");
          noContent.textContent = "Không có mã nguồn";
          contentElement.appendChild(noContent);
          return;
        }

        if (parsedContent.html) {
          const htmlLabel = document.createElement("h4");
          htmlLabel.textContent = "HTML";
          htmlLabel.style.marginBottom = "0.5rem";
          contentElement.appendChild(htmlLabel);

          const htmlPre = document.createElement("pre");
          const htmlCode = document.createElement("code");
          htmlCode.textContent =
            parsedContent.html.trim() || "Không có nội dung HTML";
          htmlPre.appendChild(htmlCode);
          contentElement.appendChild(htmlPre);
        }

        if (parsedContent.css) {
          const cssLabel = document.createElement("h4");
          cssLabel.textContent = "CSS";
          cssLabel.style.margin = "1rem 0 0.5rem 0";
          contentElement.appendChild(cssLabel);

          const cssPre = document.createElement("pre");
          const cssCode = document.createElement("code");
          cssCode.textContent =
            parsedContent.css.trim() || "Không có nội dung CSS";
          cssPre.appendChild(cssCode);
          contentElement.appendChild(cssPre);
        }

        if (parsedContent.js) {
          const jsLabel = document.createElement("h4");
          jsLabel.textContent = "JavaScript";
          jsLabel.style.margin = "1rem 0 0.5rem 0";
          contentElement.appendChild(jsLabel);

          const jsPre = document.createElement("pre");
          const jsCode = document.createElement("code");
          jsCode.textContent =
            parsedContent.js.trim() || "Không có nội dung JavaScript";
          jsPre.appendChild(jsCode);
          contentElement.appendChild(jsPre);
        }
      }

      // Hàm hiển thị thông tin khác của bài nộp
      function displaySubmissionInfo(submission) {
        document.getElementById("ten-hien-thi").textContent =
          submission.ten_hien_thi || "N/A";
        document.getElementById("thoi-gian-nop").textContent =
          submission.thoi_gian_nop
            ? new Date(submission.thoi_gian_nop).toLocaleString("vi-VN")
            : "N/A";
        document.getElementById("trang-thai").textContent =
          submission.trang_thai || "N/A";
        document.getElementById("lan-nop").textContent =
          submission.lan_nop || "N/A";

        if (submission.tap_tin_nop) {
          const contentElement = document.getElementById(
            "submissionContentOld"
          );
          const fileLink = document.createElement("a");
          fileLink.href = `http://127.0.0.1:8000${submission.tap_tin_nop}`;
          fileLink.textContent = "Tải file đính kèm";
          fileLink.style.display = "block";
          fileLink.style.marginTop = "1rem";
          contentElement.appendChild(fileLink);
        }
      }

      // Hàm chính để tải và hiển thị nội dung bài nộp
      async function loadSubmissionContent() {
        const urlParams = new URLSearchParams(window.location.search);
        const exerciseId = urlParams.get("ma_bai_tap");
        const submissionId = urlParams.get("submission_id");

        if (!exerciseId || !submissionId) {
          showErrorMessage("Thiếu mã bài tập hoặc ID bài nộp!");
          return;
        }

        const oldContentElement = document.getElementById(
          "submissionContentOld"
        );
        const newContentElement = document.getElementById(
          "submissionContentNew"
        );
        if (!oldContentElement || !newContentElement) {
          showErrorMessage("Không tìm thấy phần tử nội dung!");
          return;
        }

        const token = await checkAndRefreshToken();
        if (!token) return;

        try {
          // Lấy dữ liệu từ API
          const submission = await fetchSubmissionData(
            exerciseId,
            submissionId,
            token
          );
          console.log("submission:", submission);
          console.log("submission.noi_dung_nop:", submission.noi_dung_nop);

          // Parse nội dung bài nộp
          const { data: parsedContent, error } = parseSubmissionContent(
            submission.noi_dung_nop
          );
          if (error) {
            const errorDisplay = document.createElement("p");
            errorDisplay.textContent = error;
            oldContentElement.appendChild(errorDisplay);
            return;
          }

          // Hiển thị dạng cũ và dạng mới
          displayOldFormat(parsedContent, oldContentElement);
          displayNewFormat(parsedContent, newContentElement);

          // Hiển thị thông tin khác
          displaySubmissionInfo(submission);
        } catch (err) {
          console.error("Lỗi:", err);
          showErrorMessage(
            "Đã xảy ra lỗi khi tải nội dung bài nộp: " + err.message
          );
        }
      }

      // Hàm làm mới token
      async function refreshToken() {
        const refreshToken = localStorage.getItem("refresh_token");
        if (!refreshToken) {
          throw new Error("Không có refresh token");
        }

        const response = await fetch("http://127.0.0.1:8000/refresh_token", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `refresh_token=${encodeURIComponent(refreshToken)}`,
        });

        console.log("Refresh token response:", response.status);
        if (!response.ok) {
          throw new Error("Làm mới token thất bại");
        }

        const data = await response.json();
        localStorage.setItem("access_token", data.access_token);
        localStorage.setItem("refresh_token", data.refresh_token);
        return data.access_token;
      }

      // Hàm khởi tạo trang
      async function initializePage() {
        let token = localStorage.getItem("access_token");
        console.log("Token from localStorage:", token);
        if (!token) {
          alert("Vui lòng đăng nhập để tiếp tục!");
          window.location.href = "/";
          return;
        }

        try {
          const response = await fetch("http://127.0.0.1:8000/check_token", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) {
            token = await refreshToken();
            localStorage.setItem("access_token", token);
          }
          const data = await response.json();
          console.log("Data from check_token:", data);

          document.getElementById("userEmail").textContent =
            data.email || "email@example.com";
          document.getElementById("userName").textContent =
            data.ten_dang_nhap || "Tên người dùng";
          const userRoleSelect = document.getElementById("editUserRole") || {};
          userRoleSelect.value = data.vai_tro || "SinhVien";
          if (!["QuanTri", "GiangVien", "SinhVien"].includes(data.vai_tro)) {
            console.warn(
              "Vai trò không hợp lệ, sử dụng giá trị mặc định:",
              data.vai_tro
            );
            userRoleSelect.value = "SinhVien";
          }
          const defaultAvatar = data.anh_dai_dien
            ? `http://127.0.0.1:8000${data.anh_dai_dien}`
            : "/images/default-avatar.png";
          document.getElementById("userAvatar").src = defaultAvatar;
          document.getElementById("userRole").textContent = `Vai trò: ${
            data.vai_tro || "Chưa xác định"
          }`;
          document.getElementById("userRoleHeader").textContent = `Vai trò: ${
            data.vai_tro || "Chưa xác định"
          }`;
          document.getElementById("userRoleHeader").classList.remove("hidden");

          localStorage.setItem("ma_nguoi_dung", data.ma_nguoi_dung || "");
          localStorage.setItem("userAvatar", defaultAvatar);
          localStorage.setItem(
            "display_name",
            data.ten_dang_nhap || "Tên người dùng"
          );
          localStorage.setItem(
            "ten_dang_nhap",
            data.ten_dang_nhap || "email@example.com"
          );
          localStorage.setItem("email", data.email || "email@example.com");
          localStorage.setItem("vai_tro", data.vai_tro || "SinhVien");

          if (data.vai_tro === "SinhVien") {
            document
              .getElementById("manageExerciseItem")
              .classList.add("hidden");
            document.getElementById("manageClassItem").classList.add("hidden");
            document.getElementById("addTeacherButton").classList.add("hidden");
            document.getElementById("addStudentButton").classList.add("hidden");
            document.getElementById("viewInfoSidebar").classList.add("hidden");
            document
              .getElementById("manageAccountItem")
              .classList.add("hidden");
          } else if (data.vai_tro === "GiangVien") {
            document.getElementById("addTeacherButton").classList.add("hidden");
          }

          const teacherInfoButton =
            document.getElementById("teacherInfoButton");
          if (teacherInfoButton && data.vai_tro === "GiangVien") {
            teacherInfoButton.classList.add("opacity-50");
          }

          // Hiển thị menu con "Quản lý bài tập" khi ở trang chi tiết bài nộp
          const exerciseSubButtons =
            document.getElementById("exerciseSubButtons");
          if (
            exerciseSubButtons &&
            window.location.pathname.includes("chitietBaiNop")
          ) {
            exerciseSubButtons.style.display = "block";
          }
        } catch (error) {
          console.error("Lỗi tải thông tin:", error);
          alert("Phiên đăng nhập hết hạn, vui lòng đăng nhập lại!");
          localStorage.removeItem("access_token");
          localStorage.removeItem("refresh_token");
          window.location.href = "/";
        }
      }

      // Sự kiện đăng xuất
      document
        .getElementById("logoutButton")
        .addEventListener("click", function () {
          localStorage.removeItem("access_token");
          localStorage.removeItem("refresh_token");
          localStorage.removeItem("ma_nguoi_dung");
          localStorage.removeItem("ten_dang_nhap");
          localStorage.removeItem("display_name");
          localStorage.removeItem("userAvatar");
          localStorage.removeItem("email");
          localStorage.removeItem("vai_tro");
          window.location.href = "/";
        });

      // Sự kiện chỉnh sửa thông tin
      document
        .querySelector(".edit-icon")
        .addEventListener("click", function (e) {
          e.preventDefault();
          window.location.href = "/chinhsuathongtin";
        });

      // Hàm điều hướng với kiểm tra vai trò
      function navigateWithRoleCheck(event, url, roleCheck) {
        event.preventDefault();
        const token = localStorage.getItem("access_token");
        if (!token) {
          alert("Vui lòng đăng nhập để tiếp tục!");
          window.location.href = "/";
          return;
        }
        fetch("http://127.0.0.1:8000/check_token", {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((response) => {
            console.log("Response from check_token:", response.status);
            return response.json();
          })
          .then((data) => {
            console.log("Data from check_token:", data);
            if (roleCheck(data.vai_tro)) {
              window.location.href = url;
            } else {
              alert("Bạn không có quyền truy cập!");
            }
          })
          .catch((error) => {
            console.error("Lỗi kiểm tra token:", error);
            alert("Phiên đăng nhập hết hạn. Vui lòng đăng nhập lại!");
            localStorage.removeItem("access_token");
            window.location.href = "/";
          });
      }

      // Sự kiện DOMContentLoaded
      document.addEventListener("DOMContentLoaded", () => {
        const createExerciseLink = document.querySelector(
          '.exercise-sub-buttons a[href="/taoBT"]'
        );
        const exerciseListLink = document.querySelector(
          '.exercise-sub-buttons a[href="/danhsachbaitap"]'
        );
        const createClassLink = document.querySelector(
          '.class-sub-buttons a[href="/taolophoc"]'
        );
        const classListLink = document.querySelector(
          '.class-sub-buttons a[href="/danhsachlop"]'
        );
        const addTeacherLink = document.querySelector(
          '.account-sub-buttons a[href="/themgiangvien"]'
        );
        const addStudentLink = document.querySelector(
          '.account-sub-buttons a[href="/themsinhvien"]'
        );
        const searchClassSidebar =
          document.getElementById("searchClassSidebar");
        const viewInfoSidebar = document.getElementById("viewInfoSidebar");
        const manageExerciseSidebar = document.getElementById(
          "manageExerciseSidebar"
        );
        const manageClassSidebar =
          document.getElementById("manageClassSidebar");
        const manageAccountSidebar = document.getElementById(
          "manageAccountSidebar"
        );

        if (viewInfoSidebar) {
          viewInfoSidebar.onclick = (e) => {
            e.preventDefault();
            const infoSubButtons = document.getElementById("infoSubButtons");
            infoSubButtons.style.display =
              infoSubButtons.style.display === "block" ? "none" : "block";
            const vaiTro = localStorage.getItem("vai_tro");
            const teacherInfoButton =
              document.getElementById("teacherInfoButton");
            if (teacherInfoButton) {
              if (vaiTro === "GiangVien") {
                teacherInfoButton.classList.add("hidden");
              } else {
                teacherInfoButton.classList.remove("hidden");
              }
            }
          };
        }

        if (manageExerciseSidebar) {
          manageExerciseSidebar.onclick = (e) => {
            e.preventDefault();
            const vaiTro = localStorage.getItem("vai_tro");
            if (vaiTro === "SinhVien") {
              alert("Bạn không có quyền truy cập!");
              return;
            }
            const exerciseSubButtons =
              document.getElementById("exerciseSubButtons");
            console.log("Toggling exerciseSubButtons:", exerciseSubButtons);
            exerciseSubButtons.style.display =
              exerciseSubButtons.style.display === "block" ? "none" : "block";
          };
        }

        if (manageClassSidebar) {
          manageClassSidebar.onclick = (e) => {
            e.preventDefault();
            const classSubButtons = document.getElementById("classSubButtons");
            classSubButtons.style.display =
              classSubButtons.style.display === "block" ? "none" : "block";
          };
        }

        if (manageAccountSidebar) {
          manageAccountSidebar.onclick = (e) => {
            e.preventDefault();
            const accountSubButtons =
              document.getElementById("accountSubButtons");
            const infoSubButtons = document.getElementById("infoSubButtons");
            const exerciseSubButtons =
              document.getElementById("exerciseSubButtons");
            const manageAccountSidebar = document.getElementById(
              "manageAccountSidebar"
            );

            if (accountSubButtons.style.display === "block") {
              accountSubButtons.style.display = "none";
              manageAccountSidebar.classList.remove("active");
              manageAccountSidebar.style.backgroundColor = "#f0f2f5";
              manageAccountSidebar.style.color = "#333333";
            } else {
              accountSubButtons.style.display = "block";
              if (infoSubButtons) infoSubButtons.style.display = "none";
              if (exerciseSubButtons) exerciseSubButtons.style.display = "none";
              manageAccountSidebar.classList.add("active");
              manageAccountSidebar.style.backgroundColor = "#4b6cb7";
              manageAccountSidebar.style.color = "#ffffff";
            }
          };
        }

        if (createExerciseLink) {
          createExerciseLink.onclick = (e) =>
            navigateWithRoleCheck(
              e,
              "/taoBT",
              (role) => role === "GiangVien" || role === "QuanTri"
            );
        } else {
          console.warn("Không tìm thấy createExerciseLink!");
        }

        if (exerciseListLink) {
          exerciseListLink.onclick = (e) =>
            navigateWithRoleCheck(
              e,
              "/danhsachbaitap",
              (role) => role === "GiangVien" || role === "QuanTri"
            );
        }

        if (createClassLink) {
          createClassLink.onclick = (e) =>
            navigateWithRoleCheck(
              e,
              "/taolophoc",
              (role) => role === "GiangVien" || role === "QuanTri"
            );
        }

        if (classListLink) {
          classListLink.onclick = (e) =>
            navigateWithRoleCheck(
              e,
              "/danhsachlop",
              (role) => role === "GiangVien" || role === "QuanTri"
            );
        }

        if (addTeacherLink) {
          addTeacherLink.onclick = (e) =>
            navigateWithRoleCheck(
              e,
              "/themgiangvien",
              (role) => role === "QuanTri"
            );
        }

        if (addStudentLink) {
          addStudentLink.onclick = (e) =>
            navigateWithRoleCheck(
              e,
              "/themsinhvien",
              (role) => role === "QuanTri" || role === "GiangVien"
            );
        }

        if (searchClassSidebar) {
          searchClassSidebar.onclick = (e) => {
            e.preventDefault();
            window.location.href = "/timkiemlophoc";
          };
        }

        initializePage();
        loadSubmissionContent();
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chỉnh sửa Bài tập</title>
    <link rel="icon" type="image/x-icon" href="/public/favicon.ico" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background-color: #f5f6fa;
        color: #333333;
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
      }

      .sidebar {
        width: 280px;
        background: #ffffff;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        padding: 2rem;
        border-right: 1px solid #e5e7eb;
        overflow-y: auto;
        z-index: 50;
      }

      .sidebar.hidden {
        display: none;
      }

      .sidebar .user-info {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 0.1rem;
        border-bottom: 1px solid #e5e7eb;
        position: relative;
      }

      .sidebar .user-info img {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        margin-right: 1rem;
        object-fit: cover;
        border: 2px solid #4b6cb7;
      }

      .sidebar .user-info .edit-icon {
        position: absolute;
        top: 48px;
        right: 5px;
        background: #4b6cb7;
        border-radius: 50%;
        padding: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .sidebar .user-info .edit-icon svg {
        width: 16px;
        height: 16px;
        stroke: #ffffff;
      }

      .sidebar .user-info .user-details h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #333333;
        margin-bottom: 0.5rem;
      }

      .sidebar .user-info .user-details p {
        font-size: 0.875rem;
        color: #666666;
        font-weight: 500;
      }

      .sidebar nav ul {
        list-style: none;
        padding: 0;
      }

      .sidebar nav ul li {
        margin-bottom: 0.5rem;
        position: relative;
      }

      .sidebar nav ul li a {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        color: #333333;
        text-decoration: none;
        border-radius: 0.375rem;
        font-size: 0.95rem;
        background: #f0f2f5;
        transition: background-color 0.2s;
      }

      .sidebar nav ul li a.active {
        background: #4b6cb7;
        color: #ffffff;
      }

      .sidebar nav ul li a svg {
        width: 1.125rem;
        height: 1.125rem;
        margin-right: 0.5rem;
        stroke: currentColor;
      }

      .info-sub-buttons,
      .exercise-sub-buttons,
      .class-sub-buttons {
        display: none;
        margin-left: 1.5rem;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .info-sub-buttons a,
      .exercise-sub-buttons a,
      .class-sub-buttons a {
        display: flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        font-size: 0.85rem;
        color: #333333;
        text-decoration: none;
        background: #e0e7ff;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .info-sub-buttons a:hover,
      .exercise-sub-buttons a:hover,
      .class-sub-buttons a:hover {
        background-color: #c7d2fe;
        color: #1e40af;
      }

      .info-sub-buttons a.disabled,
      .exercise-sub-buttons a.disabled,
      .class-sub-buttons a.disabled {
        opacity: 0.5;
        pointer-events: none;
        cursor: not-allowed;
      }

      .exercise-sub-buttons a.active {
        background: #4b6cb7;
        color: #ffffff;
      }

      .info-sub-buttons a svg,
      .exercise-sub-buttons a svg,
      .class-sub-buttons a svg {
        width: 1rem;
        height: 1rem;
        margin-right: 0.5rem;
        stroke: currentColor;
      }

      header {
        background: #4b6cb7;
        color: #ffffff;
        padding: 1rem 2rem;
        position: fixed;
        top: 0;
        left: 280px;
        right: 0;
        z-index: 40;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 60px;
      }

      header button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        cursor: pointer;
      }

      .back-btn {
        color: #ffffff;
      }

      .logout-btn {
        color: #ffffff;
        background: #ef4444;
      }

      .main-content {
        margin-left: 280px;
        width: calc(100% - 280px); /* Giới hạn chiều rộng trừ sidebar */
        min-height: 100vh;
        padding: 0; /* Loại bỏ padding để container tự xử lý */
      }

      .content-container {
        width: 100%; /* Chiếm toàn bộ chiều rộng của main-content */
        max-width: 1900px; /* Giới hạn chiều rộng tối đa, điều chỉnh giá trị này để nhỏ hơn hoặc lớn hơn */
        margin: 0 auto; /* Canh giữa form */
        background: #ffffff;
        border-radius: 0.75rem;
        border: 1px solid #e5e7eb;
        padding: 2rem; /* Tăng padding bên trong cho thoáng */
        margin-top: 6rem; /* Giảm margin-top */
        margin-bottom: 5rem;
      }

      .success-message,
      .error-message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 1000;
        display: none;
      }

      .success-message {
        background-color: #d1fae5;
        color: #065f46;
      }

      .error-message {
        background-color: #fee2e2;
        color: #991b1b;
      }

      .success-message:not(.hidden),
      .error-message:not(.hidden) {
        display: block;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.5rem;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 1rem;
        color: #374151;
        transition: border-color 0.2s ease;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #4b6cb7;
        box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.1);
      }

      .form-group textarea {
        resize: vertical;
        min-height: 120px;
      }

      .form-group input[type="checkbox"] {
        accent-color: #4b6cb7;
        width: 1.1rem;
        height: 1.1rem;
        margin-right: 0.5rem;
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        font-size: 1rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
      }

      .btn-primary {
        background: #4b6cb7;
        color: #ffffff;
      }

      .btn-primary:hover {
        background: #3b5898;
      }

      .btn-secondary {
        background: #e5e7eb;
        color: #374151;
      }

      .btn-secondary:hover {
        background: #d1d5db;
      }

      .error {
        color: #dc2626;
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }

      .success {
        color: #059669;
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }

      @media (max-width: 768px) {
        .sidebar {
          width: 100%;
          height: auto;
          position: relative;
        }

        .main-content {
          margin-left: 0;
          width: 100%; /* Full width trên mobile */
          padding: 0;
        }

        header {
          left: 0;
        }

        .content-container {
          margin-top: 4rem;
          padding: 1rem; /* Padding nhỏ hơn trên mobile */
        }
      }
    </style>
  </head>
  <body class="font-['Inter',sans-serif] min-h-screen">
    <div id="successMessage" class="success-message hidden"></div>
    <div id="errorMessage" class="error-message hidden"></div>

    <div class="flex">
      <aside id="sidebar" class="sidebar">
        <div class="user-info">
          <img
            id="userAvatar"
            src="https://via.placeholder.com/50"
            alt="User Avatar"
          />
          <a
            href="/chinhsuathongtin"
            class="edit-icon"
            title="Chỉnh sửa thông tin"
          >
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              ></path>
            </svg>
          </a>
          <div class="user-details">
            <h3 id="userName">Tên người dùng</h3>
            <p id="userEmail">email@example.com</p>
            <p id="userRole">Vai trò: Chưa xác định</p>
          </div>
        </div>
        <nav>
          <ul>
            <li>
              <a
                href="/thongke"
                id="viewStatsSidebar"
                class="flex items-center px-4 py-2 rounded-lg font-medium"
                style="background-color: #f0f2f5; color: #333333"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  ></path>
                </svg>
                Xem thống kê
              </a>
            </li>
            <li>
              <a
                href="#"
                id="viewInfoSidebar"
                class="flex items-center px-4 py-2 rounded-lg font-medium"
                style="background-color: #f0f2f5; color: #333333"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
                Xem thông tin
              </a>
              <div class="info-sub-buttons" id="infoSubButtons">
                <a
                  href="/thongtin/giangvien"
                  class="subitem"
                  id="teacherInfoButton"
                >
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5zM12 15c-3.313 0-6 1.343-6 3v1h12v-1c0-1.657-2.687-3-6-3z"
                    ></path>
                  </svg>
                  Giảng viên
                </a>
                <a
                  href="/thongtin/sinhvien"
                  class="subitem"
                  id="studentInfoButton"
                >
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5zM12 15c-3.313 0-6 1.343-6 3v1h12v-1c0-1.657-2.687-3-6-3z"
                    ></path>
                  </svg>
                  Sinh viên
                </a>
              </div>
            </li>
            <li id="manageExerciseItem">
              <a
                href="#"
                id="manageExerciseSidebar"
                class="flex items-center px-4 py-2 rounded-lg font-medium active"
                style="background-color: #4b6cb7; color: #ffffff"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  ></path>
                </svg>
                Quản lý bài tập
              </a>
              <div class="exercise-sub-buttons" id="exerciseSubButtons">
                <a href="/taoBT" class="subitem">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    ></path>
                  </svg>
                  Tạo bài tập
                </a>
                <a href="/danhsachbaitap" class="subitem active">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                    ></path>
                  </svg>
                  Danh sách bài tập
                </a>
              </div>
            </li>
            <li id="manageClassItem">
              <a
                href="#"
                id="manageClassSidebar"
                class="flex items-center px-4 py-2 rounded-lg font-medium"
                style="background-color: #f0f2f5; color: #333333"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                  ></path>
                </svg>
                Quản lý lớp
              </a>
              <div class="class-sub-buttons" id="classSubButtons">
                <a href="/taolophoc" class="subitem">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    ></path>
                  </svg>
                  Tạo lớp học
                </a>
                <a href="/danhsachlop" class="subitem">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                    ></path>
                  </svg>
                  Danh sách lớp
                </a>
              </div>
            </li>
            <li>
              <a
                href="/timkiemlophoc"
                id="searchClassSidebar"
                class="flex items-center px-4 py-2 rounded-lg font-medium"
                style="background-color: #f0f2f5; color: #333333"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  ></path>
                </svg>
                Tìm kiếm lớp học
              </a>
            </li>
            <li id="classScheduleItem">
              <a
                href="/lophoc.html"
                id="classListSidebar"
                class="flex items-center px-4 py-2 rounded-lg font-medium"
                style="background-color: #f0f2f5; color: #333333"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                  ></path>
                </svg>
                Lớp học
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <main id="mainContent" class="main-content">
        <header>
          <button id="backButton" class="back-btn">
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 19l-7-7m0 0l7-7m-7 7h18"
              ></path>
            </svg>
            Quay lại Trang chính
          </button>
          <button id="logoutButton" class="logout-btn">
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h6a3 3 0 013 3v1"
              ></path>
            </svg>
            Đăng xuất
          </button>
        </header>

        <div
          class="content-container mx-auto bg-white rounded-lg border border-gray-200"
        >
          <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">
            Chỉnh sửa Bài tập
          </h1>
          <div id="errorMessage" class="error-message hidden"></div>
          <div id="successMessage" class="success-message hidden"></div>

          <div class="form-group">
            <label for="exerciseName">Tên bài tập</label>
            <input type="text" id="exerciseName" class="w-full" required />
          </div>

          <div class="form-group">
            <label>Nội dung bài tập</label>
            <div class="flex flex-col gap-4">
              <div>
                <label for="htmlContent" class="text-sm">Mã HTML</label>
                <textarea id="htmlContent" rows="8" class="w-full"></textarea>
              </div>
              <div>
                <label for="cssContent" class="text-sm">Mã CSS</label>
                <textarea id="cssContent" rows="8" class="w-full"></textarea>
              </div>
              <div>
                <label for="jsContent" class="text-sm">Mã JavaScript</label>
                <textarea id="jsContent" rows="8" class="w-full"></textarea>
              </div>
              <div>
                <label for="exerciseFile">Tải lên file mới (tùy chọn)</label>
                <input
                  type="file"
                  id="exerciseFile"
                  class="w-full"
                  accept=".html,.css,.js"
                />
                <p id="currentFile" class="text-sm text-gray-500"></p>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="deadline">Hạn nộp</label>
            <input
              type="datetime-local"
              id="deadline"
              class="w-full"
              required
            />
          </div>

          <div class="form-group">
            <label for="description">Mô tả</label>
            <textarea id="description" rows="4" class="w-full"></textarea>
          </div>

          <div class="form-group">
            <label>Ngôn ngữ lập trình</label>
            <div id="languageCheckboxes" class="flex flex-wrap gap-4">
              <label>
                <input type="checkbox" name="languages" value="HTML" /> HTML
              </label>
              <label>
                <input type="checkbox" name="languages" value="CSS" /> CSS
              </label>
              <label>
                <input type="checkbox" name="languages" value="JavaScript" />
                JavaScript
              </label>
              <label>
                <input type="checkbox" name="languages" value="Python" /> Python
              </label>
            </div>
          </div>

          <div class="form-group">
            <label>Lớp học</label>
            <div id="classCheckboxes" class="flex flex-wrap gap-4"></div>
          </div>

          <div class="flex justify-end gap-4">
            <button id="cancelButton" class="btn btn-secondary">Hủy</button>
            <button id="saveButton" class="btn btn-primary">
              Lưu thay đổi
            </button>
          </div>
        </div>
      </main>
    </div>

    <script>
      function showSuccessMessage(message) {
        const successMessage = document.getElementById("successMessage");
        successMessage.textContent = message;
        successMessage.classList.remove("hidden");
        setTimeout(() => successMessage.classList.add("hidden"), 3000);
      }

      function showErrorMessage(message) {
        const errorMessage = document.getElementById("errorMessage");
        errorMessage.textContent = message;
        errorMessage.classList.remove("hidden");
        setTimeout(() => errorMessage.classList.add("hidden"), 3000);
      }

      function toggleInfoSubButtons() {
        const subButtons = document.getElementById("infoSubButtons");
        const exerciseSubButtons =
          document.getElementById("exerciseSubButtons");
        const classSubButtons = document.getElementById("classSubButtons");
        subButtons.style.display =
          subButtons.style.display === "block" ? "none" : "block";
        if (exerciseSubButtons) exerciseSubButtons.style.display = "none";
        if (classSubButtons) classSubButtons.style.display = "none";
      }

      function toggleExerciseSubButtons() {
        const subButtons = document.getElementById("exerciseSubButtons");
        const infoSubButtons = document.getElementById("infoSubButtons");
        const classSubButtons = document.getElementById("classSubButtons");
        subButtons.style.display =
          subButtons.style.display === "block" ? "none" : "block";
        if (infoSubButtons) infoSubButtons.style.display = "none";
        if (classSubButtons) classSubButtons.style.display = "none";
      }

      function toggleClassSubButtons() {
        const subButtons = document.getElementById("classSubButtons");
        const infoSubButtons = document.getElementById("infoSubButtons");
        const exerciseSubButtons =
          document.getElementById("exerciseSubButtons");
        subButtons.style.display =
          subButtons.style.display === "block" ? "none" : "block";
        if (infoSubButtons) infoSubButtons.style.display = "none";
        if (exerciseSubButtons) exerciseSubButtons.style.display = "none";
      }

      async function loadClasses() {
        const token = localStorage.getItem("access_token");
        const userRole = localStorage.getItem("vai_tro");
        const currentUser = localStorage.getItem("ten_dang_nhap");

        try {
          const response = await fetch("http://127.0.0.1:8000/classes/", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) throw new Error("Không thể lấy danh sách lớp");
          const classes = await response.json();

          let filteredClasses = classes;
          if (userRole !== "QuanTri") {
            filteredClasses = classes.filter(
              (cls) => cls.ten_dang_nhap === currentUser
            );
          }

          const classCheckboxes = document.getElementById("classCheckboxes");
          classCheckboxes.innerHTML = filteredClasses
            .map(
              (cls) => `
                <label>
                  <input type="checkbox" name="classIds" value="${cls.id}" /> ${cls.ten_lop}
                </label>
              `
            )
            .join("");
        } catch (error) {
          console.error("Lỗi khi tải danh sách lớp:", error);
          showErrorMessage("Không thể tải danh sách lớp!");
        }
      }

      async function loadExerciseData() {
        const urlParams = new URLSearchParams(window.location.search);
        const exerciseId = urlParams.get("exerciseId");
        if (!exerciseId) {
          showErrorMessage("Không tìm thấy ID bài tập!");
          return;
        }

        const token = localStorage.getItem("access_token");
        try {
          const response = await fetch(
            `http://127.0.0.1:8000/exercises/${exerciseId}/`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          if (!response.ok) throw new Error("Không thể lấy thông tin bài tập");
          const exercise = await response.json();

          document.getElementById("exerciseName").value =
            exercise.tieu_de || "";
          let content = { html: "", css: "", js: "" };
          if (typeof exercise.noi_dung === "string") {
            try {
              content = JSON.parse(exercise.noi_dung);
            } catch (e) {
              content = { html: exercise.noi_dung, css: "", js: "" };
            }
          } else {
            content = exercise.noi_dung || content;
          }
          document.getElementById("htmlContent").value = content.html || "";
          document.getElementById("cssContent").value = content.css || "";
          document.getElementById("jsContent").value = content.js || "";
          document.getElementById("deadline").value = exercise.han_nop
            ? new Date(exercise.han_nop).toISOString().slice(0, 16)
            : "";
          document.getElementById("description").value = exercise.mo_ta || "";
          document.getElementById("currentFile").textContent =
            exercise.exercise_file
              ? `Tệp hiện tại: ${exercise.exercise_file.split("/").pop()}`
              : "Không có tệp";

          const languageCheckboxes = document.querySelectorAll(
            'input[name="languages"]'
          );
          languageCheckboxes.forEach((checkbox) => {
            checkbox.checked = exercise.ngon_ngu.includes(checkbox.value);
          });

          const classCheckboxes = document.querySelectorAll(
            'input[name="classIds"]'
          );
          classCheckboxes.forEach((checkbox) => {
            checkbox.checked = exercise.class_ids.includes(
              Number(checkbox.value)
            );
          });
        } catch (error) {
          console.error("Lỗi khi tải thông tin bài tập:", error);
          showErrorMessage("Lỗi khi tải thông tin bài tập!");
        }
      }

      async function saveExercise() {
        const token = localStorage.getItem("access_token");
        const userRole = localStorage.getItem("vai_tro");
        const ten_dang_nhap = localStorage.getItem("ten_dang_nhap");
        const urlParams = new URLSearchParams(window.location.search);
        const exerciseId = urlParams.get("exerciseId");

        if (!token || !exerciseId) {
          showErrorMessage("Vui lòng đăng nhập và chọn bài tập!");
          window.location.href = "/";
          return;
        }

        if (userRole !== "QuanTri" && userRole !== "GiangVien") {
          showErrorMessage("Bạn không có quyền chỉnh sửa bài tập!");
          return;
        }

        const exerciseName = document
          .getElementById("exerciseName")
          .value.trim();
        const deadline = document.getElementById("deadline").value;
        const description = document.getElementById("description").value.trim();
        const classIds = Array.from(
          document.querySelectorAll('input[name="classIds"]:checked')
        ).map((checkbox) => Number(checkbox.value));
        const languages = Array.from(
          document.querySelectorAll('input[name="languages"]:checked')
        ).map((checkbox) => checkbox.value);
        const htmlContent = document.getElementById("htmlContent").value.trim();
        const cssContent = document.getElementById("cssContent").value.trim();
        const jsContent = document.getElementById("jsContent").value.trim();
        const exerciseFile = document.getElementById("exerciseFile").files[0];

        if (!exerciseName) {
          showErrorMessage("Vui lòng nhập tên bài tập!");
          return;
        }
        if (!deadline) {
          showErrorMessage("Vui lòng chọn hạn nộp!");
          return;
        }
        if (classIds.length === 0) {
          showErrorMessage("Vui lòng chọn ít nhất một lớp!");
          return;
        }
        if (languages.length === 0) {
          showErrorMessage("Vui lòng chọn ít nhất một ngôn ngữ!");
          return;
        }

        const deadlineDate = new Date(deadline);
        const now = new Date();
        if (deadlineDate <= now) {
          showErrorMessage("Hạn nộp phải sau thời điểm hiện tại!");
          return;
        }

        let fileContent = { html: "", css: "", js: "" };
        if (exerciseFile) {
          const allowedExtensions = [".html", ".css", ".js"];
          const fileExtension = exerciseFile.name
            .substring(exerciseFile.name.lastIndexOf("."))
            .toLowerCase();

          if (!allowedExtensions.includes(fileExtension)) {
            showErrorMessage("Chỉ chấp nhận file .html, .css, hoặc .js!");
            document.getElementById("exerciseFile").value = "";
            return;
          }

          if (exerciseFile.size > 5 * 1024 * 1024) {
            showErrorMessage("File không được vượt quá 5MB!");
            document.getElementById("exerciseFile").value = "";
            return;
          }

          try {
            const text = await exerciseFile.text();
            if (fileExtension === ".html") fileContent.html = text;
            else if (fileExtension === ".css") fileContent.css = text;
            else if (fileExtension === ".js") fileContent.js = text;
          } catch (error) {
            showErrorMessage("Lỗi khi đọc file tải lên!");
            console.error("Lỗi đọc file:", error);
            return;
          }
        }

        const exerciseData = {
          tieu_de: exerciseName,
          noi_dung: {
            html: htmlContent || fileContent.html,
            css: cssContent || fileContent.css,
            js: jsContent || fileContent.js,
          },
          han_nop: deadlineDate.toISOString(),
          ngay_tao: now.toISOString(),
          mo_ta: description || null,
          ngon_ngu: languages,
          class_ids: classIds,
          ten_dang_nhap: ten_dang_nhap,
        };

        const formData = new FormData();
        formData.append("exercise", JSON.stringify(exerciseData));
        if (exerciseFile) {
          formData.append("exercise_file", exerciseFile);
        }

        try {
          const response = await fetch(
            `http://127.0.0.1:8000/exercises/${exerciseId}/`,
            {
              method: "PUT",
              headers: { Authorization: `Bearer ${token}` },
              body: formData,
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || "Không thể cập nhật bài tập!");
          }

          showSuccessMessage("Cập nhật bài tập thành công!");
          setTimeout(() => {
            window.location.href = `/chitietBT.html?exerciseId=${exerciseId}`;
          }, 1000);
        } catch (error) {
          console.error("Lỗi khi cập nhật bài tập:", error);
          showErrorMessage(`Lỗi: ${error.message}`);
        }
      }

      async function loadPage() {
        const token = localStorage.getItem("access_token");
        if (!token) {
          showErrorMessage("Vui lòng đăng nhập để tiếp tục!");
          window.location.href = "/";
          return;
        }

        const userName = document.getElementById("userName");
        const userEmail = document.getElementById("userEmail");
        const userRole = document.getElementById("userRole");
        const userAvatar = document.getElementById("userAvatar");
        const viewStatsSidebar = document.getElementById("viewStatsSidebar");
        const viewInfoSidebar = document.getElementById("viewInfoSidebar");
        const manageExerciseSidebar = document.getElementById(
          "manageExerciseSidebar"
        );
        const manageClassSidebar =
          document.getElementById("manageClassSidebar");
        const manageExerciseItem =
          document.getElementById("manageExerciseItem");
        const manageClassItem = document.getElementById("manageClassItem");
        const searchClassSidebar =
          document.getElementById("searchClassSidebar");
        const classListSidebar = document.getElementById("classListSidebar");
        const classScheduleItem = document.getElementById("classScheduleItem");
        const backButton = document.getElementById("backButton");
        const logoutButton = document.getElementById("logoutButton");
        const sidebar = document.getElementById("sidebar");
        const teacherInfoButton = document.getElementById("teacherInfoButton");
        const studentInfoButton = document.getElementById("studentInfoButton");

        if (
          !userName ||
          !userEmail ||
          !userRole ||
          !userAvatar ||
          !viewStatsSidebar ||
          !viewInfoSidebar ||
          !manageExerciseSidebar ||
          !manageClassSidebar ||
          !manageExerciseItem ||
          !manageClassItem ||
          !searchClassSidebar ||
          !classListSidebar ||
          !classScheduleItem ||
          !backButton ||
          !logoutButton ||
          !sidebar ||
          !teacherInfoButton ||
          !studentInfoButton
        ) {
          console.error("Không tìm thấy một hoặc nhiều phần tử cần thiết.");
          showErrorMessage("Lỗi giao diện, vui lòng thử lại!");
          return;
        }

        try {
          const response = await fetch(
            `http://127.0.0.1:8000/check_token/?_=${Date.now()}`,
            {
              headers: { Authorization: `Bearer ${token}` },
              cache: "no-store",
            }
          );
          if (!response.ok) {
            if (response.status === 401) {
              localStorage.removeItem("access_token");
              localStorage.removeItem("ten_dang_nhap");
              localStorage.removeItem("userAvatar");
              localStorage.removeItem("display_name");
              localStorage.removeItem("vai_tro");
              window.location.href = "/";
            }
            throw new Error("Phiên đăng nhập không hợp lệ!");
          }

          const userData = await response.json();
          const role = userData.vai_tro;

          const storedDisplayName = localStorage.getItem("display_name");
          userName.textContent =
            userData.display_name ||
            storedDisplayName ||
            userData.ten_dang_nhap ||
            "Tên người dùng";
          userEmail.textContent = userData.ten_dang_nhap || "email@example.com";
          userRole.textContent = `Vai trò: ${
            userData.vai_tro || "Chưa xác định"
          }`;
          const avatar =
            userData.avatar ||
            localStorage.getItem("userAvatar") ||
            `https://via.placeholder.com/50?text=${encodeURIComponent(
              userData.ten_dang_nhap || "User"
            )}`;
          userAvatar.src = avatar;

          localStorage.setItem("userAvatar", avatar);
          localStorage.setItem(
            "display_name",
            userData.display_name || storedDisplayName || userData.ten_dang_nhap
          );
          localStorage.setItem("ten_dang_nhap", userData.ten_dang_nhap);
          localStorage.setItem("vai_tro", userData.vai_tro);

          sidebar.classList.remove("hidden");

          viewStatsSidebar.classList.add("hidden");
          viewInfoSidebar.classList.add("hidden");
          manageExerciseItem.classList.add("hidden");
          manageClassItem.classList.add("hidden");
          searchClassSidebar.classList.add("hidden");
          classScheduleItem.classList.add("hidden");
          document.getElementById("exerciseSubButtons").style.display = "block";
          document.getElementById("classSubButtons").style.display = "none";
          document.getElementById("infoSubButtons").style.display = "none";

          if (role === "QuanTri") {
            viewStatsSidebar.classList.remove("hidden");
            viewInfoSidebar.classList.remove("hidden");
            searchClassSidebar.classList.remove("hidden");
            classScheduleItem.classList.remove("hidden");
            teacherInfoButton.classList.remove("disabled");
            studentInfoButton.classList.remove("disabled");
          } else if (role === "GiangVien") {
            viewStatsSidebar.classList.remove("hidden");
            viewInfoSidebar.classList.remove("hidden");
            manageExerciseItem.classList.remove("hidden");
            manageClassItem.classList.remove("hidden");
            searchClassSidebar.classList.remove("hidden");
            classScheduleItem.classList.remove("hidden");
            teacherInfoButton.classList.add("disabled");
            studentInfoButton.classList.remove("disabled");
          } else {
            showErrorMessage("Bạn không có quyền truy cập trang này!");
            window.location.href = "/";
            return;
          }

          viewStatsSidebar.onclick = function (e) {
            e.preventDefault();
            if (role === "QuanTri" || role === "GiangVien") {
              window.location.href = "/thongke";
            } else {
              showErrorMessage("Bạn không có quyền xem thống kê!");
            }
          };

          viewInfoSidebar.onclick = function (e) {
            e.preventDefault();
            toggleInfoSubButtons();
          };

          manageExerciseSidebar.onclick = function (e) {
            e.preventDefault();
            if (role === "GiangVien" || role === "QuanTri") {
              toggleExerciseSubButtons();
            } else {
              showErrorMessage("Bạn không có quyền quản lý bài tập!");
            }
          };

          manageClassSidebar.onclick = function (e) {
            e.preventDefault();
            if (role === "GiangVien" || role === "QuanTri") {
              toggleClassSubButtons();
            } else {
              showErrorMessage("Bạn không có quyền quản lý lớp học!");
            }
          };

          searchClassSidebar.onclick = function (e) {
            e.preventDefault();
            if (role === "QuanTri" || role === "GiangVien") {
              window.location.href = "/timkiemlophoc";
            } else {
              showErrorMessage("Bạn không có quyền tìm kiếm lớp học!");
            }
          };

          classListSidebar.onclick = function (e) {
            e.preventDefault();
            if (role === "QuanTri" || role === "GiangVien") {
              window.location.href = "/lophoc.html";
            } else {
              showErrorMessage("Bạn không có quyền xem danh sách lớp!");
            }
          };

          document
            .querySelectorAll("#exerciseSubButtons .subitem")
            .forEach((item) => {
              if (item.textContent.trim() === "Tạo bài tập") {
                item.onclick = function (e) {
                  e.preventDefault();
                  if (role !== "GiangVien" && role !== "QuanTri") {
                    showErrorMessage("Bạn không có quyền tạo bài tập!");
                    return;
                  }
                  window.location.href = "/taoBT";
                };
              } else if (item.textContent.trim() === "Danh sách bài tập") {
                item.onclick = function (e) {
                  e.preventDefault();
                  if (role !== "GiangVien" && role !== "QuanTri") {
                    showErrorMessage(
                      "Bạn không có quyền xem danh sách bài tập!"
                    );
                    return;
                  }
                  window.location.href = "/danhsachbaitap";
                };
              }
            });

          document
            .querySelectorAll("#classSubButtons .subitem")
            .forEach((item) => {
              if (item.textContent.trim() === "Tạo lớp học") {
                item.onclick = function (e) {
                  e.preventDefault();
                  if (role !== "GiangVien" && role !== "QuanTri") {
                    showErrorMessage("Bạn không có quyền tạo lớp học!");
                    return;
                  }
                  window.location.href = "/taolophoc";
                };
              } else if (item.textContent.trim() === "Danh sách lớp") {
                item.onclick = function (e) {
                  e.preventDefault();
                  if (role !== "GiangVien" && role !== "QuanTri") {
                    showErrorMessage("Bạn không có quyền xem danh sách lớp!");
                    return;
                  }
                  window.location.href = "/danhsachlop";
                };
              }
            });

          document
            .querySelector(".edit-icon")
            .addEventListener("click", function (e) {
              e.preventDefault();
              if (role === "QuanTri" || role === "GiangVien") {
                window.location.href = "/chinhsuathongtin";
              } else {
                showErrorMessage(
                  "Bạn không có quyền chỉnh sửa thông tin cá nhân!"
                );
              }
            });

          backButton.onclick = function () {
            window.location.href = "/";
          };

          logoutButton.onclick = function () {
            localStorage.removeItem("access_token");
            localStorage.removeItem("ten_dang_nhap");
            localStorage.removeItem("userAvatar");
            localStorage.removeItem("display_name");
            localStorage.removeItem("vai_tro");
            window.location.href = "/";
          };

          document.getElementById("cancelButton").onclick = function () {
            window.location.href = "/danhsachbaitap";
          };

          document.getElementById("saveButton").onclick = saveExercise;

          await loadClasses();
          await loadExerciseData();
        } catch (error) {
          console.error("Lỗi:", error);
          showErrorMessage(`Lỗi: ${error.message}`);
          localStorage.removeItem("access_token");
          localStorage.removeItem("ten_dang_nhap");
          localStorage.removeItem("userAvatar");
          localStorage.removeItem("display_name");
          localStorage.removeItem("vai_tro");
          window.location.href = "/";
        }
      }

      document.addEventListener("DOMContentLoaded", loadPage);
    </script>
  </body>
</html>

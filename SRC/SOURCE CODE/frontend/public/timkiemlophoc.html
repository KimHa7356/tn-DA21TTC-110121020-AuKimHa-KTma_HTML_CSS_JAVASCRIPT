<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tìm Kiếm Lớp Học</title>
    <link rel="stylesheet" href="/public/output.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=block"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background-color: #f5f6fa;
        color: #333333;
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
      }
      .hidden {
        display: none !important;
      }
      .sidebar {
        width: 280px;
        background: #ffffff;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        padding: 2rem;
        border-right: 1px solid #e5e7eb;
        overflow-y: auto;
        z-index: 50;
      }
      .sidebar .user-info {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
        position: relative;
      }
      .sidebar .user-info img {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        margin-right: 1rem;
        object-fit: cover;
        border: 2px solid #4b6cb7;
      }
      .sidebar .user-info .edit-icon {
        position: absolute;
        top: 48px;
        right: 5px;
        background: #4b6cb7;
        border-radius: 50%;
        padding: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .sidebar .user-info .edit-icon svg {
        width: 16px;
        height: 16px;
        stroke: #ffffff;
      }
      .sidebar .user-info .user-details h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #333333;
      }
      .sidebar .user-info .user-details p {
        font-size: 0.875rem;
        color: #666666;
        font-weight: 500;
      }
      .sidebar nav ul {
        list-style: none;
        padding: 0;
      }
      .sidebar nav ul li {
        margin-bottom: 0.5rem;
      }
      .sidebar nav ul li a {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        color: #333333;
        text-decoration: none;
        border-radius: 0.375rem;
        font-size: 0.95rem;
        background: #f0f2f5;
        transition: background-color 0.2s;
        position: relative;
      }
      .sidebar nav ul li a.active {
        background: #4b6cb7;
        color: #ffffff;
      }
      .sidebar nav ul li a svg {
        width: 1.125rem;
        height: 1.125rem;
        margin-right: 0.5rem;
        stroke: currentColor;
      }
      .info-sub-buttons,
      .class-sub-buttons,
      .exercise-sub-buttons,
      .account-sub-buttons {
        display: none;
        margin-left: 1.5rem;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
      }
      .info-sub-buttons a,
      .class-sub-buttons a,
      .exercise-sub-buttons a,
      .account-sub-buttons a {
        display: flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        font-size: 0.85rem;
        color: #333333;
        text-decoration: none;
        background: #e0e7ff;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      .info-sub-buttons a:hover,
      .class-sub-buttons a:hover,
      .exercise-sub-buttons a:hover,
      .account-sub-buttons a:hover {
        background-color: #c7d2fe;
        color: #1e40af;
      }
      .info-sub-buttons a.disabled,
      .class-sub-buttons a.disabled,
      .exercise-sub-buttons a.disabled,
      .account-sub-buttons a.disabled {
        opacity: 0.5;
        pointer-events: none;
        cursor: not-allowed;
      }
      .info-sub-buttons a svg,
      .class-sub-buttons a svg,
      .exercise-sub-buttons a svg,
      .account-sub-buttons a svg {
        width: 1rem;
        height: 1rem;
        margin-right: 0.5rem;
        stroke: currentColor;
      }
      .main-content {
        margin-left: 280px;
        min-height: 100vh;
        padding: 2rem;
        padding-top: 70px;
        transition: all 0.3s ease;
      }
      .main-content.ml-0 {
        margin-left: 0;
      }
      header {
        background: #4b6cb7;
        color: #ffffff;
        padding: 1rem 2rem;
        position: fixed;
        top: 0;
        left: 280px;
        right: 0;
        z-index: 40;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 60px;
      }
      header button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        cursor: pointer;
      }
      .back-btn {
        color: #ffffff;
      }
      .logout-btn {
        color: #ffffff;
        background: #ef4444;
      }
      .success-message,
      .error-message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 1000;
        display: none;
      }
      .success-message {
        background-color: #d1fae5;
        color: #065f46;
      }
      .error-message {
        background-color: #fee2e2;
        color: #991b1b;
      }
      .success-message:not(.hidden),
      .error-message:not(.hidden) {
        display: block;
      }
      .search-container {
        max-width: 90%;
        margin: 4rem auto 0 auto;
        background: #ffffff;
        border-radius: 0.75rem;
        border: 1px solid #e5e7eb;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .search-container h2 {
        font-size: 2rem;
        font-weight: 700;
        color: #1e3a8a;
        margin-bottom: 1.5rem;
        text-align: center;
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      .form-group label {
        display: block;
        font-size: 1rem;
        font-weight: 500;
        color: #6b7280;
        margin-bottom: 0.5rem;
      }
      .form-group input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 1rem;
        color: #333333;
        background: #ffffff;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }
      .form-group input:focus {
        outline: none;
        border-color: #4b6cb7;
        box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.1);
      }
      .class-list {
        margin-top: 2rem;
      }
      .class-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.3s ease;
      }
      .class-item:hover {
        background: #f0f2f5;
      }
      .class-item p {
        margin: 0;
        color: #4b5563;
      }
      .join-btn {
        padding: 0.5rem 1rem;
        background: #4b6cb7;
        color: #ffffff;
        border: none;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      .join-btn:hover {
        background: #1e3a8a;
      }
      .join-btn:disabled {
        background: #d1d5db;
        cursor: not-allowed;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: #ffffff;
        padding: 2rem;
        border-radius: 0.5rem;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .modal-content h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 1rem;
      }
      .modal-content .form-group {
        margin-bottom: 1rem;
      }
      .modal-content .btn-group {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
      }
      .modal-content .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
      }
      .modal-content .btn-primary {
        background: #4b6cb7;
        color: #ffffff;
      }
      .modal-content .btn-primary:hover {
        background: #1e3a8a;
      }
      .modal-content .btn-secondary {
        background: #e5e7eb;
        color: #333333;
      }
      .modal-content .btn-secondary:hover {
        background: #d1d5db;
      }
      @media (max-width: 768px) {
        .sidebar {
          width: 100%;
          height: auto;
          position: relative;
        }
        .main-content {
          margin-left: 0;
          padding-top: 5rem;
        }
        header {
          left: 0;
        }
        .search-container {
          margin-top: 5rem;
          padding: 1rem;
          max-width: 95%;
        }
        .modal-content {
          margin: 1rem;
        }
      }
    </style>
  </head>
  <body class="font-['Inter',sans-serif] min-h-screen">
    <div id="successMessage" class="success-message hidden"></div>
    <div id="errorMessage" class="error-message hidden"></div>

    <aside id="sidebar" class="sidebar">
      <div class="user-info">
        <img
          id="userAvatar"
          src="/images/default-avatar.png"
          alt="Ảnh đại diện người dùng"
        />
        <a
          href="/chinhsuathongtin"
          class="edit-icon"
          title="Chỉnh sửa thông tin"
          aria-label="Chỉnh sửa thông tin cá nhân"
          rel="noopener noreferrer"
        >
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M11 5H6a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
            ></path>
          </svg>
        </a>
        <div class="user-details">
          <h3 id="userName">Tên người dùng</h3>
          <p id="userEmail">email@example.com</p>
          <p id="userRole">Vai trò: Chưa xác định</p>
        </div>
      </div>
      <nav>
        <ul>
          <li>
            <a
              href="#"
              id="viewInfoSidebar"
              class="flex items-center px-4 py-2 rounded-lg font-medium"
              style="background-color: #f0f2f5; color: #333333"
              aria-label="Xem thông tin"
            >
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              Xem thông tin
            </a>
            <div class="info-sub-buttons" id="infoSubButtons">
              <a
                href="/thongtin/giangvien"
                class="subitem"
                id="teacherInfoButton"
                aria-label="Thông tin giảng viên"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5zM12 15c-3.313 0-6 1.343-6 3v1h12v-1c0-1.657-2.687-3-6-3z"
                  ></path>
                </svg>
                Giảng viên
              </a>
              <a
                href="/thongtin/sinhvien"
                class="subitem"
                aria-label="Thông tin sinh viên"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5zM12 15c-3.313 0-6 1.343-6 3v1h12v-1c0-1.657-2.687-3-6-3z"
                  ></path>
                </svg>
                Sinh viên
              </a>
            </div>
          </li>
          <li id="manageExerciseItem">
            <a
              href="#"
              id="manageExerciseSidebar"
              class="flex items-center px-4 py-2 rounded-lg font-medium"
              style="background-color: #f0f2f5; color: #333333"
              aria-label="Quản lý bài tập"
            >
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v16m8-8H4"
                ></path>
              </svg>
              Quản lý bài tập
            </a>
            <div class="exercise-sub-buttons" id="exerciseSubButtons">
              <a href="/taoBT" class="subitem" aria-label="Tạo bài tập">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  ></path>
                </svg>
                Tạo bài tập
              </a>
              <a
                href="/danhsachbaitap"
                class="subitem"
                aria-label="Danh sách bài tập"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                  ></path>
                </svg>
                Danh sách bài tập
              </a>
            </div>
          </li>
          <li id="manageClassItem">
            <a
              href="#"
              id="manageClassSidebar"
              class="flex items-center px-4 py-2 rounded-lg font-medium"
              style="background-color: #f0f2f5; color: #333333"
              aria-label="Quản lý lớp"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 18"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                ></path>
              </svg>
              Quản lý lớp
            </a>
            <div class="class-sub-buttons" id="classSubButtons">
              <a href="/taolophoc" class="subitem" aria-label="Tạo lớp học">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  ></path>
                </svg>
                Tạo lớp học
              </a>
              <a href="/danhsachlop" class="subitem" aria-label="Danh sách lớp">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                  ></path>
                </svg>
                Danh sách lớp
              </a>
            </div>
          </li>
          <li>
            <a
              href="/timkiemlophoc"
              id="searchClassSidebar"
              class="flex items-center px-4 py-2 rounded-lg font-medium active"
              style="background-color: #4b6cb7; color: #ffffff"
              aria-label="Tìm kiếm lớp học"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                ></path>
              </svg>
              Tìm kiếm lớp học
            </a>
          </li>
          <li id="manageAccountItem">
            <a
              href="#"
              id="manageAccountSidebar"
              class="flex items-center px-4 py-2 rounded-lg font-medium"
              style="background-color: #f0f2f5; color: #333333"
              aria-label="Quản lý tài khoản"
            >
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                ></path>
              </svg>
              Quản lý tài khoản
            </a>
            <div class="account-sub-buttons" id="accountSubButtons">
              <a
                href="/themgiangvien"
                class="subitem"
                id="addTeacherButton"
                aria-label="Thêm giảng viên"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5zM12 15c-3.313 0-6 1.343-6 3v1h12v-1c0-1.657-2.687-3-6-3z"
                  ></path>
                </svg>
                Thêm giảng viên
              </a>
              <a
                href="/themsinhvien"
                class="subitem"
                id="addStudentButton"
                aria-label="Thêm sinh viên"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5zM12 15c-3.313 0-6 1.343-6 3v1h12v-1c0-1.657-2.687-3-6-3z"
                  ></path>
                </svg>
                Thêm sinh viên
              </a>
            </div>
          </li>
          <li>
            <a
              href="/lophoc.html"
              id="classListSidebar"
              class="flex items-center px-4 py-2 rounded-lg font-medium"
              style="background-color: #f0f2f5; color: #333333"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                ></path>
              </svg>
              Lớp học
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <header>
        <div class="flex items-center space-x-2">
          <button
            id="homeButton"
            class="back-btn"
            onclick="window.location.href='/';"
          >
            <svg
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              style="width: 1.25rem; height: 1.25rem"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 19l-7-7m0 0l7-7m-7 7h18"
              ></path>
            </svg>
            Quay lại Trang chính
          </button>
        </div>
        <div class="flex items-center space-x-2">
          <span
            id="userRoleHeader"
            class="text-white font-medium hidden"
          ></span>
          <button id="logoutButton" class="logout-btn">
            <svg
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              style="width: 1.25rem; height: 1.25rem"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 16l-4-4m0 0l-4-4m4 4H7m5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h3a3 3 0 013 3v1"
              ></path>
            </svg>
            Đăng xuất
          </button>
        </div>
      </header>

      <div class="search-container">
        <h2>Tìm Kiếm Lớp Học</h2>
        <div class="form-group">
          <label for="searchInput">Tên lớp học</label>
          <input
            type="text"
            id="searchInput"
            placeholder="Nhập tên lớp học để tìm kiếm"
            oninput="searchClasses()"
          />
        </div>
        <div class="class-list" id="classList"></div>
      </div>

      <div id="joinClassModal" class="modal">
        <div class="modal-content">
          <h3>Tham gia lớp học</h3>
          <div class="form-group">
            <label for="classCodeInput">Nhập mã lớp</label>
            <input
              type="text"
              id="classCodeInput"
              placeholder="Mã lớp (ví dụ: ABC123)"
            />
          </div>
          <div class="btn-group">
            <button id="cancelJoinButton" class="btn btn-secondary">Hủy</button>
            <button id="confirmJoinButton" class="btn btn-primary">
              Xác nhận
            </button>
          </div>
        </div>
      </div>
    </main>

    <script>
      async function refreshToken() {
        const refreshToken = localStorage.getItem("refresh_token");
        if (!refreshToken) {
          throw new Error("Không có refresh token");
        }

        const response = await fetch("http://127.0.0.1:8000/refresh_token", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `refresh_token=${encodeURIComponent(refreshToken)}`,
        });

        if (!response.ok) {
          throw new Error("Làm mới token thất bại");
        }

        const data = await response.json();
        localStorage.setItem("access_token", data.access_token);
        localStorage.setItem("refresh_token", data.refresh_token);
        return data.access_token;
      }

      async function checkLoginStatus() {
        const token = localStorage.getItem("access_token");
        const userName = document.getElementById("userName");
        const userEmail = document.getElementById("userEmail");
        const userRole = document.getElementById("userRole");
        const userAvatar = document.getElementById("userAvatar");
        const userRoleHeader = document.getElementById("userRoleHeader");
        const viewInfoSidebar = document.getElementById("viewInfoSidebar");
        const manageExerciseSidebar = document.getElementById(
          "manageExerciseSidebar"
        );
        const manageClassSidebar =
          document.getElementById("manageClassSidebar");
        const manageExerciseItem =
          document.getElementById("manageExerciseItem");
        const manageClassItem = document.getElementById("manageClassItem");
        const searchClassSidebar =
          document.getElementById("searchClassSidebar");
        const manageAccountSidebar = document.getElementById(
          "manageAccountSidebar"
        );
        const manageAccountItem = document.getElementById("manageAccountItem");
        const teacherInfoButton = document.getElementById("teacherInfoButton");
        const addTeacherButton = document.getElementById("addTeacherButton");
        const addStudentButton = document.getElementById("addStudentButton");
        const classListSidebar = document.getElementById("classListSidebar");

        if (!token) {
          alert("Vui lòng đăng nhập để tiếp tục!");
          window.location.href = "/";
          return;
        }

        try {
          let response = await fetch("http://127.0.0.1:8000/check_token", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) {
            const newToken = await refreshToken();
            response = await fetch("http://127.0.0.1:8000/check_token", {
              headers: { Authorization: `Bearer ${newToken}` },
            });
            if (!response.ok) {
              throw new Error("Không thể xác thực token");
            }
          }
          const data = await response.json();

          // Hiển thị thông tin người dùng
          userName.textContent = data.ten_dang_nhap || "Tên người dùng";
          userEmail.textContent = data.email || "email@example.com";
          userRole.textContent = `Vai trò: ${data.vai_tro || "Chưa xác định"}`;
          userRoleHeader.textContent = `Vai trò: ${
            data.vai_tro || "Chưa xác định"
          }`;
          userRoleHeader.classList.remove("hidden");
          const defaultAvatar = data.anh_dai_dien
            ? `http://127.0.0.1:8000${data.anh_dai_dien}`
            : "/images/default-avatar.png";
          userAvatar.src = defaultAvatar;

          // Lưu thông tin vào localStorage
          localStorage.setItem("ma_nguoi_dung", data.ma_nguoi_dung || "");
          localStorage.setItem("userAvatar", defaultAvatar);
          localStorage.setItem(
            "display_name",
            data.ten_dang_nhap || "Tên người dùng"
          );
          localStorage.setItem(
            "ten_dang_nhap",
            data.ten_dang_nhap || "email@example.com"
          );
          localStorage.setItem("email", data.email || "email@example.com");
          localStorage.setItem("vai_tro", data.vai_tro || "SinhVien");

          // Điều chỉnh quyền truy cập dựa trên vai_tro
          if (data.vai_tro === "QuanTri") {
            viewInfoSidebar.classList.remove("hidden");
            manageExerciseSidebar.classList.remove("hidden");
            manageClassSidebar.classList.remove("hidden");
            searchClassSidebar.classList.remove("hidden");
            manageAccountSidebar.classList.remove("hidden");
            classListSidebar.classList.add("hidden"); // Thêm dòng này để ẩn nút "Lớp học"
            teacherInfoButton.classList.remove("disabled");
            addTeacherButton.classList.remove("hidden");
            addStudentButton.classList.remove("hidden");
          } else if (data.vai_tro === "GiangVien") {
            viewInfoSidebar.classList.remove("hidden");
            manageExerciseSidebar.classList.remove("hidden");
            manageClassSidebar.classList.remove("hidden");
            searchClassSidebar.classList.remove("hidden");
            manageAccountSidebar.classList.remove("hidden");
            classListSidebar.classList.add("hidden"); // Ẩn nút "Lớp học"
            teacherInfoButton.classList.add("hidden");
            addTeacherButton.classList.add("hidden");
            addStudentButton.classList.remove("hidden");
          } else if (data.vai_tro === "SinhVien") {
            viewInfoSidebar.classList.add("hidden");
            manageExerciseItem.classList.add("hidden");
            manageClassItem.classList.add("hidden");
            searchClassSidebar.classList.remove("hidden");
            manageAccountItem.classList.add("hidden");
            classListSidebar.classList.remove("hidden");
            teacherInfoButton.classList.add("hidden");
            addTeacherButton.classList.add("hidden");
            addStudentButton.classList.add("hidden");
          }
        } catch (error) {
          console.error("Lỗi kiểm tra token:", error);
          alert("Phiên đăng nhập hết hạn, vui lòng đăng nhập lại!");
          localStorage.removeItem("access_token");
          localStorage.removeItem("refresh_token");
          window.location.href = "/";
        }
      }

      let allClasses = [];
      let currentClassId = null;

      function showSuccessMessage(message) {
        const successMessage = document.getElementById("successMessage");
        successMessage.textContent = message;
        successMessage.classList.remove("hidden");
        setTimeout(() => successMessage.classList.add("hidden"), 3000);
      }

      function showErrorMessage(message) {
        const errorMessage = document.getElementById("errorMessage");
        errorMessage.textContent = message;
        errorMessage.classList.remove("hidden");
        setTimeout(() => errorMessage.classList.add("hidden"), 3000);
      }

      function showJoinClassModal(classId) {
        currentClassId = classId;
        const modal = document.getElementById("joinClassModal");
        const classCodeInput = document.getElementById("classCodeInput");
        classCodeInput.value = "";
        modal.style.display = "flex";
      }

      function hideJoinClassModal() {
        const modal = document.getElementById("joinClassModal");
        modal.style.display = "none";
        currentClassId = null;
      }

      async function joinClass(classId, classCode) {
        const token = localStorage.getItem("access_token");
        const tenDangNhap = localStorage.getItem("ten_dang_nhap");

        if (!token) {
          showErrorMessage("Vui lòng đăng nhập để tham gia lớp!");
          window.location.href = "/";
          return;
        }

        if (!classCode) {
          showErrorMessage("Vui lòng nhập mã lớp!");
          return;
        }

        const classItem = allClasses.find((cls) => cls.id === classId);
        if (
          classItem &&
          classItem.students &&
          classItem.students.includes(tenDangNhap)
        ) {
          showErrorMessage("Bạn đã có trong lớp!");
          hideJoinClassModal();
          return;
        }

        try {
          const response = await fetch(
            `http://127.0.0.1:8000/classes/${classId}/join/`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ class_code: classCode }),
              cache: "no-store",
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || "Không thể tham gia lớp!");
          }

          showSuccessMessage("Tham gia lớp học thành công!");
          hideJoinClassModal();
          const joinButton = document.querySelector(
            `.join-btn[data-class-id="${classId}"]`
          );
          if (joinButton) {
            joinButton.disabled = true;
            joinButton.textContent = "Đã tham gia";
          }
          await loadClasses();
        } catch (error) {
          console.error("Lỗi khi tham gia lớp:", error);
          showErrorMessage(`Lỗi: ${error.message}`);
        }
      }

      async function loadClasses() {
        const token = localStorage.getItem("access_token");
        if (!token) {
          alert("Vui lòng đăng nhập!");
          window.location.href = "/";
          return;
        }

        try {
          const response = await fetch("http://127.0.0.1:8000/classes/", {
            headers: { Authorization: `Bearer ${token}` },
            cache: "no-store",
          });
          if (!response.ok) {
            throw new Error(
              `Không thể lấy danh sách lớp! Mã lỗi: ${response.status}`
            );
          }

          allClasses = await response.json();
          displayClasses(allClasses);
        } catch (error) {
          console.error("Lỗi khi tải danh sách lớp:", error);
          showErrorMessage(`Lỗi: ${error.message}`);
        }
      }

      async function getTeacherName(maGiangVien) {
        const token = localStorage.getItem("access_token");
        try {
          const response = await fetch(
            `http://127.0.0.1:8000/users/${maGiangVien}/`,
            {
              headers: { Authorization: `Bearer ${token}` },
              cache: "no-store",
            }
          );
          if (!response.ok)
            throw new Error("Không thể lấy thông tin giảng viên");
          const data = await response.json();
          return data.ten_dang_nhap || "Không xác định";
        } catch (error) {
          console.error("Lỗi khi lấy tên giảng viên:", error);
          return "Không xác định";
        }
      }

      async function displayClasses(classes) {
        const classList = document.getElementById("classList");
        classList.innerHTML = "";
        if (classes.length === 0) {
          classList.innerHTML = "<p>Không tìm thấy lớp học nào.</p>";
          return;
        }

        for (const classItem of classes) {
          const teacherName = await getTeacherName(classItem.ma_giang_vien);
          const div = document.createElement("div");
          div.className = "class-item";
          const isJoined =
            classItem.students &&
            classItem.students.includes(localStorage.getItem("ten_dang_nhap"));
          div.innerHTML = `
            <div>
              <p><strong>Tên lớp:</strong> ${classItem.ten_lop}</p>
              <p><strong>Người tạo:</strong> ${teacherName}</p>
            </div>
            <button class="join-btn" data-class-id="${
              classItem.id
            }" onclick="showJoinClassModal(${classItem.id})" ${
            isJoined
              ? 'disabled style="background: #d1d5db; cursor: not-allowed;"'
              : ""
          }>
              ${isJoined ? "Đã tham gia" : "Tham gia lớp"}
            </button>
          `;
          classList.appendChild(div);
        }
      }

      function searchClasses() {
        const searchInput = document
          .getElementById("searchInput")
          .value.trim()
          .toLowerCase();
        const filteredClasses = allClasses.filter((classItem) =>
          classItem.ten_lop.toLowerCase().includes(searchInput)
        );
        displayClasses(filteredClasses);
      }

      function navigateWithRoleCheck(event, url, roleCheck) {
        event.preventDefault();
        const token = localStorage.getItem("access_token");
        if (!token) {
          alert("Vui lòng đăng nhập để tiếp tục!");
          window.location.href = "/";
          return;
        }
        fetch("http://127.0.0.1:8000/check_token", {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((response) => {
            if (!response.ok) {
              return refreshToken().then((newToken) => {
                return fetch("http://127.0.0.1:8000/check_token", {
                  headers: { Authorization: `Bearer ${newToken}` },
                });
              });
            }
            return response;
          })
          .then((response) => response.json())
          .then((data) => {
            if (roleCheck(data.vai_tro)) {
              window.location.href = url;
            } else {
              showErrorMessage("Bạn không có quyền truy cập!");
            }
          })
          .catch((error) => {
            console.error("Lỗi kiểm tra token:", error);
            alert("Phiên đăng nhập hết hạn. Vui lòng đăng nhập lại!");
            localStorage.removeItem("access_token");
            localStorage.removeItem("refresh_token");
            window.location.href = "/";
          });
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const createExerciseLink = document.querySelector(
          '.exercise-sub-buttons a[href="/taoBT"]'
        );
        const exerciseListLink = document.querySelector(
          '.exercise-sub-buttons a[href="/danhsachbaitap"]'
        );
        const createClassLink = document.querySelector(
          '.class-sub-buttons a[href="/taolophoc"]'
        );
        const classListLink = document.querySelector(
          '.class-sub-buttons a[href="/danhsachlop"]'
        );
        const addTeacherLink = document.querySelector(
          '.account-sub-buttons a[href="/themgiangvien"]'
        );
        const addStudentLink = document.querySelector(
          '.account-sub-buttons a[href="/themsinhvien"]'
        );
        const searchClassSidebar =
          document.getElementById("searchClassSidebar");
        const viewInfoSidebar = document.getElementById("viewInfoSidebar");
        const manageExerciseSidebar = document.getElementById(
          "manageExerciseSidebar"
        );
        const manageClassSidebar =
          document.getElementById("manageClassSidebar");
        const manageAccountSidebar = document.getElementById(
          "manageAccountSidebar"
        );

        if (viewInfoSidebar) {
          viewInfoSidebar.onclick = (e) => {
            e.preventDefault();
            const infoSubButtons = document.getElementById("infoSubButtons");
            infoSubButtons.style.display =
              infoSubButtons.style.display === "block" ? "none" : "block";
          };
        }
        if (manageExerciseSidebar) {
          manageExerciseSidebar.onclick = (e) => {
            e.preventDefault();
            const vaiTro = localStorage.getItem("vai_tro");
            if (vaiTro === "SinhVien") {
              showErrorMessage("Bạn không có quyền truy cập!");
              return;
            }
            const exerciseSubButtons =
              document.getElementById("exerciseSubButtons");
            exerciseSubButtons.style.display =
              exerciseSubButtons.style.display === "block" ? "none" : "block";
          };
        }
        if (manageClassSidebar) {
          manageClassSidebar.onclick = (e) => {
            e.preventDefault();
            const classSubButtons = document.getElementById("classSubButtons");
            classSubButtons.style.display =
              classSubButtons.style.display === "block" ? "none" : "block";
          };
        }
        if (manageAccountSidebar) {
          manageAccountSidebar.onclick = (e) => {
            e.preventDefault();
            const accountSubButtons =
              document.getElementById("accountSubButtons");
            accountSubButtons.style.display =
              accountSubButtons.style.display === "block" ? "none" : "block";
          };
        }

        if (createExerciseLink) {
          createExerciseLink.onclick = (e) =>
            navigateWithRoleCheck(
              e,
              "/taoBT",
              (role) => role === "GiangVien" || role === "QuanTri"
            );
        }
        if (exerciseListLink) {
          exerciseListLink.onclick = (e) =>
            navigateWithRoleCheck(
              e,
              "/danhsachbaitap",
              (role) => role === "GiangVien" || role === "QuanTri"
            );
        }
        if (createClassLink) {
          createClassLink.onclick = (e) =>
            navigateWithRoleCheck(
              e,
              "/taolophoc",
              (role) => role === "GiangVien" || role === "QuanTri"
            );
        }
        if (classListLink) {
          classListLink.onclick = (e) =>
            navigateWithRoleCheck(
              e,
              "/danhsachlop",
              (role) => role === "GiangVien" || role === "QuanTri"
            );
        }
        if (addTeacherLink) {
          addTeacherLink.onclick = (e) =>
            navigateWithRoleCheck(
              e,
              "/themgiangvien",
              (role) => role === "QuanTri"
            );
        }
        if (addStudentLink) {
          addStudentLink.onclick = (e) =>
            navigateWithRoleCheck(
              e,
              "/themsinhvien",
              (role) => role === "QuanTri" || role === "GiangVien"
            );
        }

        document
          .querySelector(".edit-icon")
          .addEventListener("click", function (e) {
            e.preventDefault();
            window.location.href = "/chinhsuathongtin";
          });

        document
          .getElementById("logoutButton")
          .addEventListener("click", function () {
            localStorage.removeItem("access_token");
            localStorage.removeItem("refresh_token");
            localStorage.removeItem("ma_nguoi_dung");
            localStorage.removeItem("ten_dang_nhap");
            localStorage.removeItem("display_name");
            localStorage.removeItem("userAvatar");
            localStorage.removeItem("email");
            localStorage.removeItem("vai_tro");
            window.location.href = "/";
          });

        document
          .getElementById("confirmJoinButton")
          .addEventListener("click", () => {
            const classCode = document
              .getElementById("classCodeInput")
              .value.trim();
            if (currentClassId) {
              joinClass(currentClassId, classCode);
            }
          });

        document
          .getElementById("cancelJoinButton")
          .addEventListener("click", hideJoinClassModal);

        await checkLoginStatus();
        await loadClasses();
      });
    </script>
  </body>
</html>

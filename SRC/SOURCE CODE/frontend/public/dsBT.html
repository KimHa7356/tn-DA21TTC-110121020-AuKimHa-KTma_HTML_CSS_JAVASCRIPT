<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Danh sách Bài tập</title>
    <link rel="stylesheet" href="/public/output.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f5f6fa;
        color: #333333;
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
      }

      .sidebar {
        width: 280px;
        background: #ffffff;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        padding: 2rem;
        border-right: 1px solid #e5e7eb;
        overflow-y: auto;
        z-index: 50;
      }

      .hidden {
        display: none !important;
      }

      .sidebar .user-info {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
        position: relative;
      }

      .sidebar .user-info img {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        margin-right: 1rem;
        object-fit: cover;
        border: 2px solid #4b6cb7;
      }

      .sidebar .user-info .edit-icon {
        position: absolute;
        top: 48px;
        right: 5px;
        background: #4b6cb7;
        border-radius: 50%;
        padding: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .sidebar .user-info .edit-icon svg {
        width: 16px;
        height: 16px;
        stroke: #ffffff;
      }

      .sidebar .user-info .user-details h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #333333;
      }

      .sidebar .user-info .user-details p {
        font-size: 0.875rem;
        color: #666666;
        font-weight: 500;
      }

      .sidebar nav ul {
        list-style: none;
        padding: 0;
      }

      .sidebar nav ul li {
        margin-bottom: 0.5rem;
        position: relative;
      }

      .sidebar nav ul li a {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        color: #333333;
        text-decoration: none;
        border-radius: 0.375rem;
        font-size: 0.95rem;
        background: #f0f2f5;
        transition: background-color 0.2s;
      }

      .sidebar nav ul li a.active {
        background: #4b6cb7;
        color: #ffffff;
      }

      .sidebar nav ul li a svg {
        width: 1.125rem;
        height: 1.125rem;
        margin-right: 0.5rem;
        stroke: currentColor;
      }

      .info-sub-buttons,
      .exercise-sub-buttons,
      .class-sub-buttons,
      .account-sub-buttons {
        display: none;
        margin-left: 1.5rem;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .info-sub-buttons a,
      .class-sub-buttons a,
      .exercise-sub-buttons a,
      .account-sub-buttons a {
        display: flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        font-size: 0.85rem;
        color: #333333;
        text-decoration: none;
        background: #e0e7ff;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .info-sub-buttons a:hover,
      .class-sub-buttons a:hover,
      .exercise-sub-buttons a:hover,
      .account-sub-buttons a:hover:not(.disabled) {
        background-color: #c7d2fe;
        color: #1e40af;
      }

      .info-sub-buttons a.disabled,
      .exercise-sub-buttons a.disabled,
      .class-sub-buttons a.disabled,
      .account-sub-buttons a.disabled {
        opacity: 0.5;
        pointer-events: none;
        cursor: not-allowed;
      }

      .exercise-sub-buttons a.active,
      .class-sub-buttons a.active {
        background: #4b6cb7;
        color: #ffffff;
      }

      .info-sub-buttons a svg,
      .class-sub-buttons a svg,
      .exercise-sub-buttons a svg,
      .account-sub-buttons a svg {
        width: 1rem;
        height: 1rem;
        margin-right: 0.5rem;
        stroke: currentColor;
      }

      .main-content {
        margin-left: 280px;
        min-height: 100vh;
        padding: 2rem;
        padding-top: 6rem;
        transition: all 0.3s ease;
      }

      .main-content.ml-0 {
        margin-left: 0;
      }

      header {
        background: #4b6cb7;
        color: #ffffff;
        padding: 1rem 2rem;
        position: fixed;
        top: 0;
        left: 280px;
        right: 0;
        z-index: 40;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 60px;
      }

      header button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        cursor: pointer;
      }

      .back-btn {
        color: #ffffff;
      }

      .logout-btn {
        color: #ffffff;
        background: #ef4444;
      }

      .success-message,
      .error-message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 1000;
        display: none;
      }

      .success-message {
        background-color: #d1fae5;
        color: #065f46;
      }

      .error-message {
        background-color: #fee2e2;
        color: #991b1b;
      }

      .success-message:not(.hidden),
      .error-message:not(.hidden) {
        display: block;
      }

      .max-w-7.5xl {
        max-width: 1200px;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 0.75rem;
        border: 1px solid #e5e7eb;
        padding: 1.5rem;
        margin-top: 5rem;
      }

      .table-section {
        background: #ffffff;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
        margin-bottom: 2rem;
      }

      table {
        border-collapse: collapse;
        width: 100%;
      }

      th,
      td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }

      th {
        background: #60a5fa;
        color: #ffffff;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
      }

      td {
        font-size: 0.9rem;
        color: #374151;
      }

      tr:nth-child(even) {
        background-color: #f9fafb;
      }

      .bg-blue-600 {
        background-color: #60a5fa;
      }

      h1#statsTitle {
        font-size: 1.875rem;
        font-weight: 700;
        text-align: center;
        color: #1e293b;
        margin-bottom: 2rem;
        white-space: normal;
        overflow-wrap: break-word;
        line-height: 1.2;
      }

      .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1.5rem;
      }

      .pagination button {
        padding: 0.5rem 1rem;
        border: 1px solid #d1d5db;
        background-color: #ffffff;
        border-radius: 0.375rem;
        cursor: pointer;
        color: #374151;
        font-size: 0.9rem;
        transition: all 0.2s ease;
      }

      .pagination button:hover:not(:disabled) {
        background-color: #f3f4f6;
        border-color: #9ca3af;
      }

      .pagination button.active {
        background: #3b82f6;
        color: #ffffff;
        border-color: #3b82f6;
      }

      .pagination button:disabled {
        background-color: #d1d5db;
        cursor: not-allowed;
        opacity: 0.7;
      }

      #editModal {
        position: fixed;
        inset: 0;
        background-color: rgba(96, 165, 250, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }

      #editModal .bg-white {
        background-color: #ffffff;
        border-radius: 0.5rem;
        padding: 1.5rem;
        width: 100%;
        max-width: 28rem;
      }

      #editModal h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
      }

      #editModal .mb-4 {
        margin-bottom: 1rem;
      }

      #editModal label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #4b5563;
        margin-bottom: 0.25rem;
      }

      #editModal input,
      #editModal textarea {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
      }

      #editModal textarea {
        resize: vertical;
      }

      #editModal .flex {
        display: flex;
      }

      #editModal .justify-end {
        justify-content: flex-end;
      }

      #editModal .gap-2 {
        gap: 0.5rem;
      }

      #editModal button {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        border: none;
        cursor: pointer;
      }

      #editModal #cancelEdit {
        background-color: #d1d5db;
      }

      #editModal #saveEdit {
        background-color: #3b82f6;
        color: #ffffff;
      }

      @media (max-width: 768px) {
        .sidebar {
          width: 100%;
          height: auto;
          position: relative;
        }

        .main-content {
          margin-left: 0;
        }

        header {
          left: 0;
        }

        .max-w-7.5xl {
          margin-top: 4rem;
          padding: 1rem;
        }

        .table-section {
          padding: 1rem;
        }

        th,
        td {
          padding: 0.5rem 0.75rem;
        }
      }
    </style>
  </head>
  <body class="font-['Inter',sans-serif] min-h-screen">
    <!-- Thanh thông báo -->
    <div id="successMessage" class="success-message hidden"></div>
    <div id="errorMessage" class="error-message hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="user-info">
        <img
          id="userAvatar"
          src="https://via.placeholder.com/50"
          alt="User Avatar"
        />
        <a
          href="/chinhsuathongtin"
          class="edit-icon"
          title="Chỉnh sửa thông tin"
        >
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M11 5H6a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
            ></path>
          </svg>
        </a>
        <div class="user-details">
          <h3 id="userName">Tên người dùng</h3>
          <p id="userEmail">email@example.com</p>
          <p id="userRole">Vai trò: Chưa xác định</p>
        </div>
      </div>
      <nav>
        <ul>
          <li>
            <a
              href="#"
              id="viewInfoSidebar"
              class="flex items-center px-4 py-2 rounded-lg font-medium"
              style="background-color: #f0f2f5; color: #333333"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              Xem thông tin
            </a>
            <div class="info-sub-buttons" id="infoSubButtons">
              <a href="/thongtin/giangvien" class="subitem" id="giangVienLink">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5zM12 15c-3.313 0-6 1.343-6 3v1h12v-1c0-1.657-2.687-3-6-3z"
                  ></path>
                </svg>
                Giảng viên
              </a>
              <a href="/thongtin/sinhvien" class="subitem" id="sinhVienLink">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5zM12 15c-3.313 0-6 1.343-6 3v1h12v-1c0-1.657-2.687-3-6-3z"
                  ></path>
                </svg>
                Sinh viên
              </a>
            </div>
          </li>
          <li id="manageExerciseItem">
            <a
              href="#"
              id="manageExerciseSidebar"
              class="flex items-center px-4 py-2 rounded-lg font-medium active"
              style="background-color: #4b6cb7; color: #ffffff"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v16m8-8H4"
                ></path>
              </svg>
              Quản lý bài tập
            </a>
            <div class="exercise-sub-buttons" id="exerciseSubButtons">
              <a href="/taoBT" class="subitem">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  ></path>
                </svg>
                Tạo bài tập
              </a>
              <a href="/danhsachbaitap" class="subitem active">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                  ></path>
                </svg>
                Danh sách bài tập
              </a>
            </div>
          </li>
          <li id="manageClassItem">
            <a
              href="#"
              id="manageClassSidebar"
              class="flex items-center px-4 py-2 rounded-lg font-medium"
              style="background-color: #f0f2f5; color: #333333"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                ></path>
              </svg>
              Quản lý lớp
            </a>
            <div class="class-sub-buttons" id="classSubButtons">
              <a href="/taolophoc" class="subitem">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  ></path>
                </svg>
                Tạo lớp học
              </a>
              <a href="/danhsachlop" class="subitem">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                  ></path>
                </svg>
                Danh sách lớp
              </a>
            </div>
          </li>
          <li>
            <a
              href="/timkiemlophoc"
              id="searchClassSidebar"
              class="flex items-center px-4 py-2 rounded-lg font-medium"
              style="background-color: #f0f2f5; color: #333333"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                ></path>
              </svg>
              Tìm kiếm lớp học
            </a>
          </li>
          <li id="manageAccountItem">
            <a
              href="#"
              id="manageAccountSidebar"
              class="flex items-center px-4 py-2 rounded-lg font-medium"
              style="background-color: #f0f2f5; color: #333333"
              aria-label="Quản lý tài khoản"
            >
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                ></path>
              </svg>
              Quản lý tài khoản
            </a>
            <div class="account-sub-buttons" id="accountSubButtons">
              <a
                href="/themgiangvien"
                class="subitem"
                id="addTeacherButton"
                aria-label="Thêm giảng viên"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5zM12 15c-3.313 0-6 1.343-6 3v1h12v-1c0-1.657-2.687-3-6-3z"
                  ></path>
                </svg>
                Thêm giảng viên
              </a>
              <a
                href="/themsinhvien"
                class="subitem"
                id="addStudentButton"
                aria-label="Thêm sinh viên"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5zM12 15c-3.313 0-6 1.343-6 3v1h12v-1c0-1.657-2.687-3-6-3z"
                  ></path>
                </svg>
                Thêm sinh viên
              </a>
            </div>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- Nội dung chính -->
    <main id="mainContent" class="main-content flex-1">
      <header>
        <button id="backButton" class="back-btn">
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"
            ></path>
          </svg>
          Quay lại Trang chính
        </button>
        <button id="logoutButton" class="logout-btn">
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
            ></path>
          </svg>
          Đăng xuất
        </button>
      </header>

      <div
        class="max-w-7.5xl mx-auto bg-white rounded-lg border border-gray-200 p-6 mt-20"
      >
        <h1
          id="statsTitle"
          class="text-3xl font-bold text-center mb-8 text-gray-800"
        >
          Danh sách Bài tập
        </h1>

        <div class="table-section">
          <div class="mb-4 flex items-center">
            <select id="exerciseSelect" class="p-2 border rounded-lg mr-2 w-64">
              <option value="">Chọn bài tập</option>
            </select>
            <button
              id="viewDetailBtn"
              class="bg-blue-500 text-white px-4 py-2 rounded-lg"
            >
              Xem chi tiết
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse text-left">
              <thead class="bg-blue-600 text-white">
                <tr>
                  <th class="p-4 text-sm font-semibold uppercase">
                    Tên bài tập
                  </th>
                  <th class="p-4 text-sm font-semibold uppercase">Hạn nộp</th>
                  <th class="p-4 text-sm font-semibold uppercase">Ngôn ngữ</th>
                  <th class="p-4 text-sm font-semibold uppercase">Lớp học</th>
                  <th class="p-4 text-sm font-semibold uppercase">
                    Trạng thái
                  </th>
                  <th class="p-4 text-sm font-semibold uppercase">
                    Xem chi tiết
                  </th>
                  <th class="p-4 text-sm font-semibold uppercase">Hành động</th>
                </tr>
              </thead>
              <tbody id="exerciseListTableBody"></tbody>
            </table>
            <div
              id="noExercises"
              class="hidden text-center text-gray-600 font-medium bg-gray-100 p-4 rounded-lg mt-4"
            >
              Không có bài tập nào.
            </div>
          </div>
          <div id="exercisePagination" class="pagination"></div>
        </div>

        <!-- Modal chỉnh sửa bài tập -->
        <div
          id="editModal"
          class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50"
        >
          <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4">Chỉnh sửa Bài tập</h2>
            <form id="editForm">
              <input type="hidden" id="editExerciseId" />
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700"
                  >Tiêu đề</label
                >
                <input
                  type="text"
                  id="editTieuDe"
                  class="w-full p-2 border rounded-lg"
                  required
                />
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700"
                  >Nội dung</label
                >
                <textarea
                  id="editNoiDung"
                  class="w-full p-2 border rounded-lg"
                  rows="4"
                  required
                ></textarea>
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700"
                  >Hạn nộp</label
                >
                <input
                  type="datetime-local"
                  id="editHanNop"
                  class="w-full p-2 border rounded-lg"
                  required
                />
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700"
                  >Mô tả</label
                >
                <textarea
                  id="editMoTa"
                  class="w-full p-2 border rounded-lg"
                  rows="2"
                ></textarea>
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700"
                  >Ngôn ngữ</label
                >
                <input
                  type="text"
                  id="editNgonNgu"
                  class="w-full p-2 border rounded-lg"
                  required
                />
              </div>
              <div class="flex justify-end gap-2">
                <button
                  type="button"
                  id="cancelEdit"
                  class="px-4 py-2 bg-gray-300 rounded-lg"
                >
                  Hủy
                </button>
                <button
                  type="submit"
                  id="saveEdit"
                  class="px-4 py-2 bg-blue-600 text-white rounded-lg"
                >
                  Lưu
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>

    <script>
      function logout() {
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
        localStorage.removeItem("ten_dang_nhap");
        localStorage.removeItem("userAvatar");
        localStorage.removeItem("display_name");
        localStorage.removeItem("ma_nguoi_dung");
        window.location.href = "/";
      }

      function toggleInfoSubButtons(event) {
        event.preventDefault();
        const subButtons = document.getElementById("infoSubButtons");
        const otherSubButtons = [
          "exerciseSubButtons",
          "classSubButtons",
          "accountSubButtons",
        ];
        const currentPath = window.location.pathname;
        const vaiTro = localStorage.getItem("vai_tro"); // Lấy vai trò từ localStorage
        const giangVienLink = document.getElementById("giangVienLink");

        // Hiển thị hoặc ẩn infoSubButtons
        subButtons.style.display =
          subButtons.style.display === "block" ? "none" : "block";

        // Ẩn nút "Giảng viên" nếu vai trò là GiangVien
        if (vaiTro === "GiangVien" && giangVienLink) {
          giangVienLink.classList.add("hidden");
        }

        // Chỉ ẩn các subButtons khác nếu không phải trang /danhsachbaitap
        otherSubButtons.forEach((id) => {
          const other = document.getElementById(id);
          if (
            other &&
            !(id === "exerciseSubButtons" && currentPath === "/danhsachbaitap")
          ) {
            other.style.display = "none";
          }
        });

        // Đảm bảo exerciseSubButtons vẫn hiển thị và trạng thái active được giữ nếu đang ở /danhsachbaitap
        if (currentPath === "/danhsachbaitap") {
          document.getElementById("exerciseSubButtons").style.display = "block";
          const exerciseSubItems = document.querySelectorAll(
            "#exerciseSubButtons .subitem"
          );
          exerciseSubItems.forEach((item) => {
            item.classList.remove("active");
            item.style.backgroundColor = "#e0e7ff";
            item.style.color = "#333333";
            if (item.textContent.trim() === "Danh sách bài tập") {
              item.classList.add("active");
              item.style.backgroundColor = "#4b6cb7";
              item.style.color = "#ffffff";
            }
          });
          // Đảm bảo mục Quản lý bài tập vẫn active
          const manageExerciseSidebar = document.getElementById(
            "manageExerciseSidebar"
          );
          manageExerciseSidebar.classList.add("active");
          manageExerciseSidebar.style.backgroundColor = "#4b6cb7";
          manageExerciseSidebar.style.color = "#ffffff";
        }
      }

      function toggleExerciseSubButtons(event) {
        event.preventDefault();
        const subButtons = document.getElementById("exerciseSubButtons");
        const otherSubButtons = [
          "infoSubButtons",
          "classSubButtons",
          "accountSubButtons",
        ];
        subButtons.style.display =
          subButtons.style.display === "block" ? "none" : "block";
        otherSubButtons.forEach((id) => {
          const other = document.getElementById(id);
          if (other) other.style.display = "none";
        });
      }

      function toggleClassSubButtons(event) {
        event.preventDefault();
        const subButtons = document.getElementById("classSubButtons");
        const currentPath = window.location.pathname;
        const otherSubButtons = ["infoSubButtons", "accountSubButtons"];
        // Chỉ ẩn exerciseSubButtons nếu không ở trang /danhsachbaitap
        if (currentPath !== "/danhsachbaitap") {
          otherSubButtons.push("exerciseSubButtons");
        }
        subButtons.style.display =
          subButtons.style.display === "block" ? "none" : "block";
        otherSubButtons.forEach((id) => {
          const other = document.getElementById(id);
          if (other) other.style.display = "none";
        });
        // Đảm bảo trạng thái active của Quản lý bài tập khi ở trang /danhsachbaitap
        if (currentPath === "/danhsachbaitap") {
          const manageExerciseSidebar = document.getElementById(
            "manageExerciseSidebar"
          );
          const exerciseSubButtons =
            document.getElementById("exerciseSubButtons");
          manageExerciseSidebar.classList.add("active");
          manageExerciseSidebar.style.backgroundColor = "#4b6cb7";
          manageExerciseSidebar.style.color = "#ffffff";
          exerciseSubButtons.style.display = "block";
          const exerciseSubItems = document.querySelectorAll(
            "#exerciseSubButtons .subitem"
          );
          exerciseSubItems.forEach((item) => {
            item.classList.remove("active");
            item.style.backgroundColor = "#e0e7ff";
            item.style.color = "#333333";
            if (item.textContent.trim() === "Danh sách bài tập") {
              item.classList.add("active");
              item.style.backgroundColor = "#4b6cb7";
              item.style.color = "#ffffff";
            }
          });
        }
      }

      function toggleAccountSubButtons(event) {
        event.preventDefault();
        const accountSubButtons = document.getElementById("accountSubButtons");
        const manageExerciseSidebar = document.getElementById(
          "manageExerciseSidebar"
        );
        const isExerciseListPage =
          manageExerciseSidebar.classList.contains("active");

        let otherSubButtons = ["infoSubButtons", "classSubButtons"];
        if (!isExerciseListPage) {
          otherSubButtons.push("exerciseSubButtons");
        }

        if (accountSubButtons.style.display === "block") {
          accountSubButtons.style.display = "none";
        } else {
          accountSubButtons.style.display = "block";
          otherSubButtons.forEach((id) => {
            const other = document.getElementById(id);
            if (other) other.style.display = "none";
          });
        }
      }

      function navigateWithRoleCheck(url, allowedRoles) {
        const vaiTro = localStorage.getItem("vai_tro");
        if (!allowedRoles.includes(vaiTro)) {
          alert("Bạn không có quyền truy cập chức năng này!");
          return;
        }
        window.location.href = url;
      }

      async function checkAndRefreshToken() {
        const token = localStorage.getItem("access_token");
        const refreshToken = localStorage.getItem("refresh_token");
        if (!token) {
          alert("Vui lòng đăng nhập để tiếp tục!");
          window.location.href = "/dangnhap";
          return null;
        }

        try {
          const response = await fetch(
            `http://127.0.0.1:8000/check_token/?_=${Date.now()}`,
            {
              headers: { Authorization: `Bearer ${token}` },
              cache: "no-store",
            }
          );
          if (!response.ok) {
            if (response.status === 401 && refreshToken) {
              const refreshResponse = await fetch(
                "http://127.0.0.1:8000/refresh_token/",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                  },
                  body: `refresh_token=${encodeURIComponent(refreshToken)}`,
                }
              );
              if (refreshResponse.ok) {
                const data = await refreshResponse.json();
                localStorage.setItem("access_token", data.access_token);
                localStorage.setItem("refresh_token", data.refresh_token);
                return data.access_token;
              } else {
                alert("Phiên làm việc đã hết hạn. Vui lòng đăng nhập lại!");
                window.location.href = "/dangnhap";
                return null;
              }
            } else {
              throw new Error("Lỗi xác thực token");
            }
          }
          return token;
        } catch (err) {
          console.error("Lỗi kiểm tra token:", err);
          alert(
            "Đã xảy ra lỗi khi xác thực. Vui lòng thử lại hoặc đăng nhập lại!"
          );
          return null;
        }
      }

      function paginate(array, pageSize, pageNumber) {
        return array.slice((pageNumber - 1) * pageSize, pageNumber * pageSize);
      }
      let isExerciseListLoaded = false;

      async function loadExercises(firstLoad = true) {
        const token = localStorage.getItem("access_token");
        if (!token) {
          if (firstLoad) {
            alert("Vui lòng đăng nhập để tiếp tục!");
            window.location.href = "/dangnhap";
          }
          return;
        }

        try {
          const newToken = await checkAndRefreshToken();
          if (!newToken) return;

          const userResponse = await fetch(
            `http://127.0.0.1:8000/check_token/?_=${Date.now()}`,
            {
              headers: { Authorization: `Bearer ${newToken}` },
              cache: "no-store",
            }
          );
          if (!userResponse.ok)
            throw new Error("Không thể lấy thông tin người dùng");

          const userData = await userResponse.json();
          localStorage.setItem("ma_nguoi_dung", userData.ma_nguoi_dung);
          localStorage.setItem("vai_tro", userData.vai_tro);

          document.getElementById("userName").textContent =
            userData.display_name ||
            localStorage.getItem("display_name") ||
            userData.ten_dang_nhap ||
            "Tên người dùng";
          document.getElementById("userEmail").textContent =
            userData.email || userData.ten_dang_nhap || "temp_1@example.com";
          document.getElementById("userRole").textContent = `Vai trò: ${
            userData.vai_tro || "Chưa xác định"
          }`;

          const avatar =
            userData.avatar ||
            localStorage.getItem("userAvatar") ||
            `https://via.placeholder.com/50?text=${encodeURIComponent(
              userData.ten_dang_nhap || "User"
            )}`;
          document.getElementById("userAvatar").src = avatar;
          localStorage.setItem("userAvatar", avatar);
          localStorage.setItem(
            "display_name",
            userData.display_name ||
              localStorage.getItem("display_name") ||
              userData.ten_dang_nhap
          );
          localStorage.setItem("ten_dang_nhap", userData.ten_dang_nhap);

          const viewInfoSidebar = document.getElementById("viewInfoSidebar");
          const manageExerciseSidebar = document.getElementById(
            "manageExerciseSidebar"
          );
          const manageClassSidebar =
            document.getElementById("manageClassSidebar");
          const searchClassSidebar =
            document.getElementById("searchClassSidebar");
          const manageAccountSidebar = document.getElementById(
            "manageAccountSidebar"
          );
          const backButton = document.getElementById("backButton");
          const logoutButton = document.getElementById("logoutButton");
          const giangVienLink = document.getElementById("giangVienLink");
          const sinhVienLink = document.getElementById("sinhVienLink");
          const addTeacherButton = document.getElementById("addTeacherButton");
          const addStudentButton = document.getElementById("addStudentButton");
          const manageExerciseItem =
            document.getElementById("manageExerciseItem");
          const manageClassItem = document.getElementById("manageClassItem");
          const manageAccountItem =
            document.getElementById("manageAccountItem");

          if (
            !viewInfoSidebar ||
            !manageExerciseSidebar ||
            !manageClassSidebar ||
            !searchClassSidebar ||
            !manageAccountSidebar ||
            !backButton ||
            !logoutButton ||
            !giangVienLink ||
            !sinhVienLink ||
            !addTeacherButton ||
            !addStudentButton ||
            !manageExerciseItem ||
            !manageClassItem ||
            !manageAccountItem
          ) {
            console.error("Không tìm thấy một hoặc nhiều phần tử cần thiết.");
            return;
          }

          const sidebarLinks = [
            viewInfoSidebar,
            manageExerciseSidebar,
            manageClassSidebar,
            searchClassSidebar,
            manageAccountSidebar,
          ];

          // Đặt lại trạng thái sidebar
          sidebarLinks.forEach((link) => {
            link.classList.remove("active");
            link.style.backgroundColor = "#f0f2f5";
            link.style.color = "#333333";
          });
          const subButtonSections = [
            "infoSubButtons",
            "exerciseSubButtons",
            "classSubButtons",
            "accountSubButtons",
          ];
          subButtonSections.forEach((id) => {
            const section = document.getElementById(id);
            if (section) section.style.display = "none";
          });

          // Kiểm tra URL hiện tại để đặt trạng thái active
          const currentPath = window.location.pathname;
          if (currentPath === "/danhsachbaitap") {
            manageExerciseSidebar.classList.add("active");
            manageExerciseSidebar.style.backgroundColor = "#4b6cb7";
            manageExerciseSidebar.style.color = "#ffffff";
            document.getElementById("exerciseSubButtons").style.display =
              "block";
            const exerciseSubItems = document.querySelectorAll(
              "#exerciseSubButtons .subitem"
            );
            exerciseSubItems.forEach((item) => {
              item.classList.remove("active");
              item.style.backgroundColor = "#e0e7ff";
              item.style.color = "#333333";
              if (item.textContent.trim() === "Danh sách bài tập") {
                item.classList.add("active");
                item.style.backgroundColor = "#4b6cb7";
                item.style.color = "#ffffff";
              }
            });
          } else if (currentPath === "/taoBT") {
            manageExerciseSidebar.classList.add("active");
            manageExerciseSidebar.style.backgroundColor = "#4b6cb7";
            manageExerciseSidebar.style.color = "#ffffff";
            document.getElementById("exerciseSubButtons").style.display =
              "block";
            const exerciseSubItems = document.querySelectorAll(
              "#exerciseSubButtons .subitem"
            );
            exerciseSubItems.forEach((item) => {
              item.classList.remove("active");
              item.style.backgroundColor = "#e0e7ff";
              item.style.color = "#333333";
              if (item.textContent.trim() === "Tạo bài tập") {
                item.classList.add("active");
                item.style.backgroundColor = "#4b6cb7";
                item.style.color = "#ffffff";
              }
            });
          } else if (currentPath === "/taolophoc") {
            manageClassSidebar.classList.add("active");
            manageClassSidebar.style.backgroundColor = "#4b6cb7";
            manageClassSidebar.style.color = "#ffffff";
            document.getElementById("classSubButtons").style.display = "block";
            const classSubItems = document.querySelectorAll(
              "#classSubButtons .subitem"
            );
            classSubItems.forEach((item) => {
              item.classList.remove("active");
              item.style.backgroundColor = "#e0e7ff";
              item.style.color = "#333333";
              if (item.textContent.trim() === "Tạo lớp học") {
                item.classList.add("active");
                item.style.backgroundColor = "#4b6cb7";
                item.style.color = "#ffffff";
              }
            });
          } else if (currentPath === "/danhsachlop") {
            manageClassSidebar.classList.add("active");
            manageClassSidebar.style.backgroundColor = "#4b6cb7";
            manageClassSidebar.style.color = "#ffffff";
            document.getElementById("classSubButtons").style.display = "block";
            const classSubItems = document.querySelectorAll(
              "#classSubButtons .subitem"
            );
            classSubItems.forEach((item) => {
              item.classList.remove("active");
              item.style.backgroundColor = "#e0e7ff";
              item.style.color = "#333333";
              if (item.textContent.trim() === "Danh sách lớp") {
                item.classList.add("active");
                item.style.backgroundColor = "#4b6cb7";
                item.style.color = "#ffffff";
              }
            });
          } else if (currentPath === "/thongtin/giangvien") {
            viewInfoSidebar.classList.add("active");
            viewInfoSidebar.style.backgroundColor = "#4b6cb7";
            viewInfoSidebar.style.color = "#ffffff";
            document.getElementById("infoSubButtons").style.display = "block";
            const infoSubItems = document.querySelectorAll(
              "#infoSubButtons .subitem"
            );
            infoSubItems.forEach((item) => {
              item.classList.remove("active");
              item.style.backgroundColor = "#e0e7ff";
              item.style.color = "#333333";
              if (item.textContent.trim() === "Giảng viên") {
                item.classList.add("active");
                item.style.backgroundColor = "#4b6cb7";
                item.style.color = "#ffffff";
              }
            });
          } else if (currentPath === "/thongtin/sinhvien") {
            viewInfoSidebar.classList.add("active");
            viewInfoSidebar.style.backgroundColor = "#4b6cb7";
            viewInfoSidebar.style.color = "#ffffff";
            document.getElementById("infoSubButtons").style.display = "block";
            const infoSubItems = document.querySelectorAll(
              "#infoSubButtons .subitem"
            );
            infoSubItems.forEach((item) => {
              item.classList.remove("active");
              item.style.backgroundColor = "#e0e7ff";
              item.style.color = "#333333";
              if (item.textContent.trim() === "Sinh viên") {
                item.classList.add("active");
                item.style.backgroundColor = "#4b6cb7";
                item.style.color = "#ffffff";
              }
            });
          } else if (currentPath === "/timkiemlophoc") {
            searchClassSidebar.classList.add("active");
            searchClassSidebar.style.backgroundColor = "#4b6cb7";
            searchClassSidebar.style.color = "#ffffff";
          } else if (
            currentPath === "/themgiangvien" ||
            currentPath === "/themsinhvien"
          ) {
            manageAccountSidebar.classList.add("active");
            manageAccountSidebar.style.backgroundColor = "#4b6cb7";
            manageAccountSidebar.style.color = "#ffffff";
            document.getElementById("accountSubButtons").style.display =
              "block";
            const accountSubItems = document.querySelectorAll(
              "#accountSubButtons .subitem"
            );
            accountSubItems.forEach((item) => {
              item.classList.remove("active");
              item.style.backgroundColor = "#e0e7ff";
              item.style.color = "#333333";
              if (
                (currentPath === "/themgiangvien" &&
                  item.textContent.trim() === "Thêm giảng viên") ||
                (currentPath === "/themsinhvien" &&
                  item.textContent.trim() === "Thêm sinh viên")
              ) {
                item.classList.add("active");
                item.style.backgroundColor = "#4b6cb7";
                item.style.color = "#ffffff";
              }
            });
          }

          // Ẩn/hiển thị các mục sidebar dựa trên vai trò
          viewInfoSidebar.classList.add("hidden");
          manageExerciseItem.classList.add("hidden");
          manageClassItem.classList.add("hidden");
          searchClassSidebar.classList.add("hidden");
          manageAccountItem.classList.remove("hidden"); // Luôn hiển thị Quản lý tài khoản

          if (userData.vai_tro === "QuanTri") {
            viewInfoSidebar.classList.remove("hidden");
            manageExerciseItem.classList.remove("hidden");
            manageClassItem.classList.remove("hidden");
            searchClassSidebar.classList.remove("hidden");
            manageAccountItem.classList.remove("hidden");
            giangVienLink.classList.remove("hidden", "disabled");
            sinhVienLink.classList.remove("disabled");
            addTeacherButton.classList.remove("hidden", "disabled");
            addStudentButton.classList.remove("hidden", "disabled");
          } else if (userData.vai_tro === "GiangVien") {
            viewInfoSidebar.classList.remove("hidden");
            manageExerciseItem.classList.remove("hidden");
            manageClassItem.classList.remove("hidden");
            searchClassSidebar.classList.remove("hidden");
            manageAccountItem.classList.remove("hidden");
            giangVienLink.classList.add("hidden"); // Ẩn nút "Giảng viên"
            sinhVienLink.classList.remove("disabled");
            addStudentButton.classList.remove("hidden", "disabled");
            addTeacherButton.classList.add("hidden"); // Ẩn nút "Thêm giảng viên"
            document.getElementById("infoSubButtons").style.display = "none"; // Ẩn danh sách con của "Xem thông tin" ban đầu
          } else if (userData.vai_tro === "SinhVien") {
            viewInfoSidebar.classList.remove("hidden");
            searchClassSidebar.classList.remove("hidden");
            manageAccountItem.classList.remove("hidden");
            giangVienLink.classList.add("hidden");
            sinhVienLink.classList.add("disabled");
            addTeacherButton.classList.add("hidden");
            addStudentButton.classList.add("hidden");
            alert("Bạn không có quyền xem danh sách bài tập!");
            window.location.href = "/";
            return;
          } else {
            alert("Bạn không có quyền truy cập trang này!");
            window.location.href = "/";
            return;
          }

          document
            .querySelector(".edit-icon")
            .addEventListener("click", function (e) {
              e.preventDefault();
              if (
                userData.vai_tro !== "QuanTri" &&
                userData.vai_tro !== "GiangVien" &&
                userData.vai_tro !== "SinhVien"
              ) {
                alert("Bạn không có quyền chỉnh sửa thông tin cá nhân!");
                return;
              }
              window.location.href = "/chinhsuathongtin";
            });

          viewInfoSidebar.onclick = function (e) {
            e.preventDefault();
            toggleInfoSubButtons(e); // Chỉ mở/đóng danh sách con
          };

          manageExerciseSidebar.onclick = function (e) {
            e.preventDefault();
            if (
              userData.vai_tro !== "GiangVien" &&
              userData.vai_tro !== "QuanTri"
            ) {
              alert("Bạn không có quyền quản lý bài tập!");
              return;
            }
            toggleExerciseSubButtons(e);
          };

          manageClassSidebar.onclick = function (e) {
            e.preventDefault();
            if (
              userData.vai_tro === "GiangVien" ||
              userData.vai_tro === "QuanTri"
            ) {
              toggleClassSubButtons(e);
            } else {
              alert("Bạn không có quyền quản lý lớp!");
            }
          };

          manageAccountSidebar.onclick = function (e) {
            e.preventDefault();
            toggleAccountSubButtons(e);
          };

          searchClassSidebar.onclick = function (e) {
            e.preventDefault();
            if (
              userData.vai_tro !== "GiangVien" &&
              userData.vai_tro !== "QuanTri" &&
              userData.vai_tro !== "SinhVien"
            ) {
              alert("Bạn không có quyền tìm kiếm lớp học!");
              return;
            }
            sidebarLinks.forEach((link) => {
              link.classList.remove("active");
              link.style.backgroundColor = "#f0f2f5";
              link.style.color = "#333333";
            });
            searchClassSidebar.classList.add("active");
            searchClassSidebar.style.backgroundColor = "#4b6cb7";
            searchClassSidebar.style.color = "#ffffff";
            window.location.href = "/timkiemlophoc";
          };

          document
            .querySelectorAll("#exerciseSubButtons .subitem")
            .forEach((item) => {
              if (item.textContent.trim() === "Tạo bài tập") {
                item.onclick = async function (e) {
                  e.preventDefault();
                  const isTokenValid = await checkAndRefreshToken();
                  if (isTokenValid) {
                    sidebarLinks.forEach((link) => {
                      link.classList.remove("hidden");
                      link.classList.remove("active");
                      link.style.backgroundColor = "#f0f2f5";
                      link.style.color = "#333333";
                    });

                    const currentPath = window.location.pathname;
                    if (currentPath === "/danhsachbaitap") {
                      manageExerciseSidebar.classList.add("active");
                      manageExerciseSidebar.style.backgroundColor = "#4b6cb7";
                      manageExerciseSidebar.style.color = "#ffffff";
                      document.getElementById(
                        "exerciseSubButtons"
                      ).style.display = "block";
                      const exerciseSubItems = document.querySelectorAll(
                        "#exerciseSubButtons .subitem"
                      );
                      exerciseSubItems.forEach((item) => {
                        item.classList.remove("active");
                        item.style.backgroundColor = "#e0e7ff";
                        item.style.color = "#333333";
                        if (item.textContent.trim() === "Danh sách bài tập") {
                          item.classList.add("active");
                          item.style.backgroundColor = "#4b6cb7";
                          item.style.color = "#ffffff";
                        }
                      });
                    }

                    window.location.href = "/taoBT";
                  }
                };
              } else if (item.textContent.trim() === "Danh sách bài tập") {
                item.onclick = async function (e) {
                  e.preventDefault();
                  const isTokenValid = await checkAndRefreshToken();
                  if (isTokenValid) {
                    sidebarLinks.forEach((link) => {
                      link.classList.remove("active");
                      link.style.backgroundColor = "#f0f2f5";
                      link.style.color = "#333333";
                    });
                    manageExerciseSidebar.classList.add("active");
                    manageExerciseSidebar.style.backgroundColor = "#4b6cb7";
                    manageExerciseSidebar.style.color = "#ffffff";
                    exerciseSubItems.forEach((subItem) => {
                      subItem.classList.remove("active");
                      subItem.style.backgroundColor = "#e0e7ff";
                      subItem.style.color = "#333333";
                      if (subItem.textContent.trim() === "Danh sách bài tập") {
                        subItem.classList.add("active");
                        subItem.style.backgroundColor = "#4b6cb7";
                        subItem.style.color = "#ffffff";
                      }
                    });
                    window.location.href = "/danhsachbaitap";
                  }
                };
              }
            });

          document
            .querySelectorAll("#classSubButtons .subitem")
            .forEach((item) => {
              if (item.textContent.trim() === "Tạo lớp học") {
                item.onclick = async function (e) {
                  e.preventDefault();
                  const isTokenValid = await checkAndRefreshToken();
                  if (isTokenValid) {
                    if (
                      userData.vai_tro !== "QuanTri" &&
                      userData.vai_tro !== "GiangVien"
                    ) {
                      alert("Bạn không có quyền tạo lớp học!");
                      return;
                    }
                    sidebarLinks.forEach((link) => {
                      link.classList.remove("active");
                      link.style.backgroundColor = "#f0f2f5";
                      link.style.color = "#333333";
                    });
                    manageClassSidebar.classList.add("active");
                    manageClassSidebar.style.backgroundColor = "#4b6cb7";
                    manageClassSidebar.style.color = "#ffffff";
                    window.location.href = "/taolophoc";
                  }
                };
              } else if (item.textContent.trim() === "Danh sách lớp") {
                item.onclick = async function (e) {
                  e.preventDefault();
                  const isTokenValid = await checkAndRefreshToken();
                  if (isTokenValid) {
                    if (
                      userData.vai_tro !== "QuanTri" &&
                      userData.vai_tro !== "GiangVien"
                    ) {
                      alert("Bạn không có quyền xem danh sách lớp!");
                      return;
                    }
                    sidebarLinks.forEach((link) => {
                      link.classList.remove("active");
                      link.style.backgroundColor = "#f0f2f5";
                      link.style.color = "#333333";
                    });
                    manageClassSidebar.classList.add("active");
                    manageClassSidebar.style.backgroundColor = "#4b6cb7";
                    manageClassSidebar.style.color = "#ffffff";
                    window.location.href = "/danhsachlop";
                  }
                };
              }
            });

          document
            .querySelectorAll("#infoSubButtons .subitem")
            .forEach((item) => {
              if (item.textContent.trim() === "Giảng viên") {
                item.onclick = async function (e) {
                  e.preventDefault();
                  const isTokenValid = await checkAndRefreshToken();
                  if (isTokenValid) {
                    sidebarLinks.forEach((link) => {
                      link.classList.remove("active");
                      link.style.backgroundColor = "#f0f2f5";
                      link.style.color = "#333333";
                    });
                    viewInfoSidebar.classList.add("active");
                    viewInfoSidebar.style.backgroundColor = "#4b6cb7";
                    viewInfoSidebar.style.color = "#ffffff";
                    window.location.href = "/thongtin/giangvien";
                  }
                };
              } else if (item.textContent.trim() === "Sinh viên") {
                item.onclick = async function (e) {
                  e.preventDefault();
                  const isTokenValid = await checkAndRefreshToken();
                  if (isTokenValid) {
                    sidebarLinks.forEach((link) => {
                      link.classList.remove("active");
                      link.style.backgroundColor = "#f0f2f5";
                      link.style.color = "#333333";
                    });
                    viewInfoSidebar.classList.add("active");
                    viewInfoSidebar.style.backgroundColor = "#4b6cb7";
                    viewInfoSidebar.style.color = "#ffffff";
                    window.location.href = "/thongtin/sinhvien";
                  }
                };
              }
            });

          document
            .querySelectorAll("#accountSubButtons .subitem")
            .forEach((item) => {
              if (item.textContent.trim() === "Thêm giảng viên") {
                item.onclick = async function (e) {
                  e.preventDefault();
                  const isTokenValid = await checkAndRefreshToken();
                  if (isTokenValid) {
                    window.location.href = "/themgiangvien"; // Loại bỏ kiểm tra quyền
                  }
                };
              } else if (item.textContent.trim() === "Thêm sinh viên") {
                item.onclick = async function (e) {
                  e.preventDefault();
                  const isTokenValid = await checkAndRefreshToken();
                  if (isTokenValid) {
                    window.location.href = "/themsinhvien"; // Loại bỏ kiểm tra quyền
                  }
                };
              }
            });

          backButton.onclick = function () {
            window.location.href = "/";
          };
          logoutButton.onclick = logout;

          const exercisesResponse = await fetch(
            "http://127.0.0.1:8000/exercises/",
            {
              headers: { Authorization: `Bearer ${newToken}` },
              cache: "no-store",
            }
          );
          if (!exercisesResponse.ok) {
            const error = await exercisesResponse.json();
            if (exercisesResponse.status === 401) {
              alert("Phiên làm việc hết hạn. Vui lòng đăng nhập lại!");
              window.location.href = "/dangnhap";
            } else if (exercisesResponse.status === 403) {
              alert("Bạn không có quyền xem danh sách bài tập!");
            } else {
              alert(
                `Lỗi: ${error.detail || "Không thể tải danh sách bài tập"}`
              );
            }
            return;
          }

          let exercises = await exercisesResponse.json();
          console.log("Dữ liệu bài tập:", exercises);
          if (!Array.isArray(exercises)) {
            console.error("Dữ liệu bài tập không phải là mảng:", exercises);
            exercises = [];
          }

          const exerciseBody = document.getElementById("exerciseListTableBody");
          const noExercises = document.getElementById("noExercises");
          const exercisePagination =
            document.getElementById("exercisePagination");
          const exerciseSelect = document.getElementById("exerciseSelect");

          const itemsPerPage = 10;
          let currentPage = 1;

          function renderExercisePage(page) {
            const paginatedExercises = paginate(exercises, itemsPerPage, page);
            if (paginatedExercises.length === 0) {
              noExercises.classList.remove("hidden");
              exerciseBody.innerHTML = "";
            } else {
              noExercises.classList.add("hidden");
              exerciseBody.innerHTML = paginatedExercises
                .map((exercise) => {
                  if (!exercise.ma_bai_tap) {
                    console.error("Mã bài tập không tồn tại:", exercise);
                    return "";
                  }
                  const deadline = exercise.han_nop
                    ? new Date(exercise.han_nop).toLocaleString("vi-VN", {
                        day: "2-digit",
                        month: "2-digit",
                        year: "numeric",
                        hour: "2-digit",
                        minute: "2-digit",
                        second: "2-digit",
                      })
                    : "Chưa xác định";
                  const status =
                    new Date(exercise.han_nop) < new Date()
                      ? "Hết hạn"
                      : "Còn hạn";
                  const tenLop =
                    Array.isArray(exercise.ma_lop) && exercise.ma_lop.length > 0
                      ? exercise.ma_lop.join(", ")
                      : "Không có lớp";
                  return `
      <tr>
        <td class="p-4 border-b border-gray-200 text-gray-700">${
          exercise.tieu_de || "Chưa có tiêu đề"
        }</td>
        <td class="p-4 border-b border-gray-200 text-gray-700">${deadline}</td>
        <td class="p-4 border-b border-gray-200 text-gray-700">${
          exercise.ngon_ngu || "Chưa xác định"
        }</td>
        <td class="p-4 border-b border-gray-200 text-gray-700">${tenLop}</td>
        <td class="p-4 border-b border-gray-200 text-gray-700">${status}</td>
        <td class="p-4 border-b border-gray-200 text-gray-700">
          <button class="view-btn bg-blue-500 text-white px-2 py-1 rounded" data-id="${
            exercise.ma_bai_tap
          }">Xem chi tiết</button>
        </td>
        <td class="p-4 border-b border-gray-200 text-gray-700">
          <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded mr-2" data-id="${
            exercise.ma_bai_tap
          }">Sửa</button>
          <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded" data-id="${
            exercise.ma_bai_tap
          }">Xóa</button>
        </td>
      </tr>`;
                })
                .filter((row) => row !== "")
                .join("");
            }

            exerciseSelect.innerHTML = '<option value="">Chọn bài tập</option>';
            exercises.forEach((exercise) => {
              if (exercise.ma_bai_tap) {
                const option = document.createElement("option");
                option.value = exercise.ma_bai_tap;
                option.textContent = exercise.tieu_de || "Chưa có tiêu đề";
                exerciseSelect.appendChild(option);
              }
            });

            const totalPages = Math.ceil(exercises.length / itemsPerPage);
            exercisePagination.innerHTML = "";
            for (let i = 1; i <= totalPages; i++) {
              const button = document.createElement("button");
              button.textContent = i;
              button.classList.toggle("active", i === page);
              button.addEventListener("click", () => {
                currentPage = i;
                renderExercisePage(currentPage);
              });
              if (i === page) button.disabled = true;
              exercisePagination.appendChild(button);
            }

            document.querySelectorAll(".view-btn").forEach((button) => {
              button.addEventListener("click", () => {
                const exerciseId = button.getAttribute("data-id");
                if (exerciseId) {
                  window.location.href = `/chitietBT?ma_bai_tap=${exerciseId}`;
                } else {
                  alert("Mã bài tập không hợp lệ!");
                }
              });
            });

            document.querySelectorAll(".edit-btn").forEach((button) => {
              button.addEventListener("click", async () => {
                const exerciseId = button.getAttribute("data-id");
                if (!exerciseId || isNaN(parseInt(exerciseId))) {
                  alert("Mã bài tập không hợp lệ!");
                  console.error("Mã bài tập không hợp lệ:", exerciseId);
                  return;
                }
                const isTokenValid = await checkAndRefreshToken();
                if (isTokenValid) {
                  window.location.href = `/suaBT?ma_bai_tap=${exerciseId}`;
                } else {
                  alert(
                    "Phiên đăng nhập không hợp lệ. Vui lòng đăng nhập lại!"
                  );
                  window.location.href = "/dangnhap";
                }
              });
            });

            document.querySelectorAll(".delete-btn").forEach((button) => {
              button.addEventListener("click", async () => {
                const exerciseId = button.getAttribute("data-id");
                console.log("Xóa bài tập với ID:", exerciseId);
                if (!exerciseId || isNaN(parseInt(exerciseId))) {
                  alert("Mã bài tập không hợp lệ!");
                  console.error("Mã bài tập không hợp lệ:", exerciseId);
                  return;
                }
                if (confirm("Bạn có chắc muốn xóa bài tập này?")) {
                  const isTokenValid = await checkAndRefreshToken();
                  console.log("Token hợp lệ:", isTokenValid);
                  if (isTokenValid) {
                    try {
                      const response = await fetch(
                        `http://127.0.0.1:8000/exercises/${exerciseId}/`,
                        {
                          method: "DELETE",
                          headers: { Authorization: `Bearer ${isTokenValid}` },
                        }
                      );
                      console.log("Phản hồi từ API:", response);
                      if (response.ok) {
                        exercises = exercises.filter(
                          (ex) => ex.ma_bai_tap != exerciseId
                        );
                        renderExercisePage(currentPage);
                        alert("Xóa bài tập thành công!");
                      } else {
                        const error = await response.json();
                        console.error("Lỗi từ API:", error);
                        alert(error.detail || "Không thể xóa bài tập!");
                      }
                    } catch (err) {
                      console.error("Lỗi khi xóa bài tập:", err);
                      alert("Đã xảy ra lỗi khi xóa bài tập!");
                    }
                  }
                }
              });
            });
          }

          document
            .getElementById("viewDetailBtn")
            .addEventListener("click", () => {
              const selectedId = exerciseSelect.value;
              if (!selectedId) {
                alert("Vui lòng chọn một bài tập!");
                return;
              }
              window.location.href = `/chitietBT?ma_bai_tap=${selectedId}`;
            });

          document
            .getElementById("editForm")
            .addEventListener("submit", async (e) => {
              e.preventDefault();
              const exerciseId =
                document.getElementById("editExerciseId").value;
              const updatedExercise = {
                tieu_de: document.getElementById("editTieuDe").value,
                noi_dung: document.getElementById("editNoiDung").value,
                han_nop: new Date(
                  document.getElementById("editHanNop").value
                ).toISOString(),
                mo_ta: document.getElementById("editMoTa").value || null,
                ngon_ngu: document.getElementById("editNgonNgu").value,
                ma_giang_vien: parseInt(localStorage.getItem("ma_nguoi_dung")),
                ma_lop: null,
                trang_thai: "mo",
              };

              const isTokenValid = await checkAndRefreshToken();
              if (isTokenValid) {
                try {
                  const response = await fetch(
                    `http://127.0.0.1:8000/exercises/${exerciseId}/`,
                    {
                      method: "PUT",
                      headers: {
                        Authorization: `Bearer ${isTokenValid}`,
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify(updatedExercise),
                    }
                  );
                  if (response.ok) {
                    const updatedData = await response.json();
                    exercises = exercises.map((ex) =>
                      ex.ma_bai_tap == exerciseId
                        ? { ...ex, ...updatedData }
                        : ex
                    );
                    renderExercisePage(currentPage);
                    document
                      .getElementById("editModal")
                      .classList.add("hidden");
                    alert("Cập nhật bài tập thành công!");
                  } else {
                    const error = await response.json();
                    alert(error.detail || "Không thể cập nhật bài tập!");
                  }
                } catch (err) {
                  console.error("Lỗi khi cập nhật bài tập:", err);
                  alert("Đã xảy ra lỗi khi cập nhật bài tập!");
                }
              }
            });

          document
            .getElementById("cancelEdit")
            .addEventListener("click", () => {
              document.getElementById("editModal").classList.add("hidden");
            });

          if (exercises.length === 0) {
            noExercises.classList.remove("hidden");
            exerciseSelect.innerHTML =
              '<option value="">Không có bài tập</option>';
          } else {
            renderExercisePage(currentPage);
          }
        } catch (err) {
          console.error("Lỗi:", err);
          alert(
            `Đã xảy ra lỗi: ${err.message}. Vui lòng thử lại hoặc đăng nhập lại nếu cần!`
          );
        }

        window.addEventListener("userAvatarUpdated", () => {
          fetch(`http://127.0.0.1:8000/check_token/?_=${Date.now()}`, {
            headers: { Authorization: `Bearer ${newToken || token}` },
            cache: "no-store",
          })
            .then((response) => response.json())
            .then((data) => {
              const avatar = data.avatar || localStorage.getItem("userAvatar");
              document.getElementById("userAvatar").src = avatar;
            });
        });

        window.addEventListener("userInfoUpdated", async () => {
          const newResponse = await fetch(
            `http://127.0.0.1:8000/check_token/?_=${Date.now()}`,
            {
              headers: { Authorization: `Bearer ${newToken || token}` },
              cache: "no-store",
            }
          );
          const newData = await newResponse.json();
          document.getElementById("userName").textContent =
            newData.display_name ||
            localStorage.getItem("display_name") ||
            newData.ten_dang_nhap ||
            "Tên người dùng";
          document.getElementById("userEmail").textContent =
            newData.ten_dang_nhap || "email@example.com";
          const avatar =
            newData.avatar ||
            localStorage.getItem("userAvatar") ||
            `https://via.placeholder.com/50?text=${encodeURIComponent(
              newData.ten_dang_nhap || "User"
            )}`;
          document.getElementById("userAvatar").src = avatar;
          localStorage.setItem("userAvatar", avatar);
          localStorage.setItem(
            "display_name",
            newData.display_name ||
              localStorage.getItem("display_name") ||
              newData.ten_dang_nhap
          );
        });

        window.addEventListener("storage", (event) => {
          if (event.key === "display_name") {
            const userName = document.getElementById("userName");
            if (userName && event.newValue) {
              userName.textContent = event.newValue || "Tên người dùng";
            }
          }
        });

        // Thêm các biến toàn cục
        let isExerciseListLoaded = false;
        let lastLoadedPath = null;
        let debounceTimeout = null;

        // Thay thế sự kiện visibilitychange và pageshow
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible") {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
              isExerciseListLoaded = false;
              loadExercises(false);
              // Ẩn lại nút "Giảng viên" nếu vai trò là GiangVien
              const vaiTro = localStorage.getItem("vai_tro");
              if (vaiTro === "GiangVien") {
                const giangVienLink = document.getElementById("giangVienLink");
                if (giangVienLink) {
                  giangVienLink.classList.add("hidden");
                }
              }
            }, 500); // Đợi 500ms để tránh gọi quá nhiều
          }
        });

        window.addEventListener("pageshow", () => {
          const currentPath = window.location.pathname;
          if (lastLoadedPath !== currentPath) {
            isExerciseListLoaded = false;
            loadExercises(false);
            // Ẩn lại nút "Giảng viên" nếu vai trò là GiangVien
            const vaiTro = localStorage.getItem("vai_tro");
            if (vaiTro === "GiangVien") {
              const giangVienLink = document.getElementById("giangVienLink");
              if (giangVienLink) {
                giangVienLink.classList.add("hidden");
              }
            }
          }
        });
      }

      async function checkAuth() {
        const token = localStorage.getItem("access_token");
        if (!token) {
          window.location.href = "/dangnhap";
          return;
        }
        try {
          const response = await fetch(
            `http://127.0.0.1:8000/check_token/?_=${Date.now()}`,
            {
              headers: { Authorization: `Bearer ${token}` },
              cache: "no-store",
            }
          );
          if (response.status === 401) {
            const refreshToken = localStorage.getItem("refresh_token");
            if (refreshToken) {
              const refreshResponse = await fetch(
                "http://127.0.0.1:8000/refresh_token/",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                  },
                  body: `refresh_token=${encodeURIComponent(refreshToken)}`,
                }
              );
              if (refreshResponse.ok) {
                const newTokens = await refreshResponse.json();
                localStorage.setItem("access_token", newTokens.access_token);
                localStorage.setItem("refresh_token", newTokens.refresh_token);
              } else {
                throw new Error("Không thể làm mới token");
              }
            } else {
              throw new Error("Không có refresh token");
            }
          }
        } catch (error) {
          console.error("Lỗi xác thực:", error);
          logout();
        }
      }

      window.onload = checkAuth;

      document.addEventListener("DOMContentLoaded", () => {
        loadExercises();
      });
    </script>
  </body>
</html>
